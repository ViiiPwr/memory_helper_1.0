<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæƒç éªŒè¯è°ƒè¯• - é…å¯¹é¢˜ç”Ÿæˆå™¨</title>
    <script src="../js/license-manager.js"></script>
    <script src="../js/license-distributor.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn-secondary {
            background: #2196F3;
        }
        .btn-secondary:hover {
            background: #1976D2;
        }
        .result {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            border: 1px solid #2196F3;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æˆæƒç éªŒè¯è°ƒè¯•å·¥å…·</h1>
        
        <div class="debug-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <div class="step">
                <strong>æ­¥éª¤1:</strong> ç‚¹å‡»"é‡æ–°åŠ è½½æˆæƒç "æŒ‰é’®
            </div>
            <div class="step">
                <strong>æ­¥éª¤2:</strong> åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥è¦æµ‹è¯•çš„æˆæƒç 
            </div>
            <div class="step">
                <strong>æ­¥éª¤3:</strong> ç‚¹å‡»"è¯¦ç»†éªŒè¯"æŒ‰é’®æŸ¥çœ‹éªŒè¯è¿‡ç¨‹
            </div>
            <div class="step">
                <strong>æ­¥éª¤4:</strong> æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯äº†è§£é—®é¢˜æ‰€åœ¨
            </div>
        </div>

        <div class="debug-section">
            <h3>ğŸ”„ é‡æ–°åŠ è½½æˆæƒç </h3>
            <button class="btn" onclick="reloadLicenses()">é‡æ–°åŠ è½½æˆæƒç </button>
            <div id="reloadResult"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ” éªŒè¯æˆæƒç </h3>
            <input type="text" id="testLicenseInput" placeholder="è¾“å…¥è¦éªŒè¯çš„æˆæƒç " />
            <button class="btn" onclick="detailedValidation()">è¯¦ç»†éªŒè¯</button>
            <button class="btn btn-secondary" onclick="simpleValidation()">ç®€å•éªŒè¯</button>
            <div id="validationResult"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <button class="btn" onclick="showCurrentState()">æ˜¾ç¤ºå½“å‰çŠ¶æ€</button>
            <div id="currentState"></div>
        </div>

        <div class="debug-section">
            <h3>ğŸ§¹ æ¸…ç†æ•°æ®</h3>
            <button class="btn" onclick="clearAllData()" style="background: #f44336;">æ¸…ç†æ‰€æœ‰æ•°æ®</button>
            <div id="clearResult"></div>
        </div>
    </div>

    <script>
        function reloadLicenses() {
            console.log('=== å¼€å§‹é‡æ–°åŠ è½½æˆæƒç  ===');
            
            // è®°å½•åŠ è½½å‰çš„çŠ¶æ€
            const beforeCount = licenseManager.validLicenses.size;
            console.log('åŠ è½½å‰æœ‰æ•ˆæˆæƒç æ•°é‡:', beforeCount);
            
            // é‡æ–°åŠ è½½
            licenseManager.loadDistributedLicenses();
            
            // è®°å½•åŠ è½½åçš„çŠ¶æ€
            const afterCount = licenseManager.validLicenses.size;
            console.log('åŠ è½½åæœ‰æ•ˆæˆæƒç æ•°é‡:', afterCount);
            
            document.getElementById('reloadResult').innerHTML = `
                <div class="result">
                    <h4>âœ… é‡æ–°åŠ è½½å®Œæˆ</h4>
                    <p>åŠ è½½å‰: ${beforeCount} ä¸ªæˆæƒç </p>
                    <p>åŠ è½½å: ${afterCount} ä¸ªæˆæƒç </p>
                    <p>æ–°å¢: ${afterCount - beforeCount} ä¸ªæˆæƒç </p>
                </div>
            `;
        }

        function detailedValidation() {
            const input = document.getElementById('testLicenseInput').value.trim();
            
            if (!input) {
                alert('è¯·è¾“å…¥æˆæƒç ');
                return;
            }

            console.log('=== å¼€å§‹è¯¦ç»†éªŒè¯ ===');
            console.log('è¾“å…¥æˆæƒç :', input);
            
            // æ­¥éª¤1: æ£€æŸ¥æ ¼å¼
            const trimmedCode = input.trim().toUpperCase();
            console.log('å¤„ç†åæˆæƒç :', trimmedCode);
            
            const formatValid = licenseManager.isValidFormat(trimmedCode);
            console.log('æ ¼å¼æ£€æŸ¥ç»“æœ:', formatValid);
            
            // æ­¥éª¤2: æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆåˆ—è¡¨ä¸­
            const inValidList = licenseManager.validLicenses.has(trimmedCode);
            console.log('æ˜¯å¦åœ¨æœ‰æ•ˆåˆ—è¡¨ä¸­:', inValidList);
            console.log('å½“å‰æœ‰æ•ˆæˆæƒç åˆ—è¡¨:', Array.from(licenseManager.validLicenses));
            
            // æ­¥éª¤3: å®Œæ•´éªŒè¯
            const result = licenseManager.validateLicense(input);
            console.log('å®Œæ•´éªŒè¯ç»“æœ:', result);
            
            // æ­¥éª¤4: æ£€æŸ¥åˆ†å‘è®°å½•
            const distributedLicenses = licenseDistributor.getAllDistributedLicenses();
            const isDistributed = distributedLicenses.some(l => l.code === trimmedCode);
            console.log('æ˜¯å¦åœ¨åˆ†å‘è®°å½•ä¸­:', isDistributed);
            console.log('åˆ†å‘è®°å½•:', distributedLicenses);
            
            document.getElementById('validationResult').innerHTML = `
                <div class="info">
                    <h4>ğŸ” è¯¦ç»†éªŒè¯ç»“æœ</h4>
                    <p><strong>è¾“å…¥æˆæƒç :</strong> ${input}</p>
                    <p><strong>å¤„ç†åæˆæƒç :</strong> ${trimmedCode}</p>
                    <p><strong>æ ¼å¼æ£€æŸ¥:</strong> ${formatValid ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</p>
                    <p><strong>åœ¨æœ‰æ•ˆåˆ—è¡¨ä¸­:</strong> ${inValidList ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    <p><strong>åœ¨åˆ†å‘è®°å½•ä¸­:</strong> ${isDistributed ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    <p><strong>æœ€ç»ˆéªŒè¯ç»“æœ:</strong> ${result.valid ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>
                    <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${result.message}</p>
                    
                    <h5>å½“å‰æœ‰æ•ˆæˆæƒç åˆ—è¡¨:</h5>
                    <pre>${JSON.stringify(Array.from(licenseManager.validLicenses), null, 2)}</pre>
                    
                    <h5>åˆ†å‘è®°å½•:</h5>
                    <pre>${JSON.stringify(distributedLicenses, null, 2)}</pre>
                    
                    <h5>å®Œæ•´éªŒè¯ç»“æœ:</h5>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        function simpleValidation() {
            const input = document.getElementById('testLicenseInput').value.trim();
            
            if (!input) {
                alert('è¯·è¾“å…¥æˆæƒç ');
                return;
            }

            const result = licenseManager.validateLicense(input);
            
            document.getElementById('validationResult').innerHTML = `
                <div class="result ${result.valid ? '' : 'error'}">
                    <h4>${result.valid ? 'âœ… éªŒè¯æˆåŠŸ' : 'âŒ éªŒè¯å¤±è´¥'}</h4>
                    <p><strong>æˆæƒç :</strong> ${input}</p>
                    <p><strong>ç»“æœ:</strong> ${result.message}</p>
                    <p><strong>ç±»å‹:</strong> ${result.type}</p>
                </div>
            `;
        }

        function showCurrentState() {
            const distributedLicenses = licenseDistributor.getAllDistributedLicenses();
            const activeLicenses = licenseDistributor.getActiveLicenses();
            const validLicenses = Array.from(licenseManager.validLicenses);
            
            document.getElementById('currentState').innerHTML = `
                <div class="info">
                    <h4>ğŸ“Š å½“å‰çŠ¶æ€</h4>
                    
                    <h5>LicenseManager çŠ¶æ€:</h5>
                    <p>æœ‰æ•ˆæˆæƒç æ•°é‡: ${licenseManager.validLicenses.size}</p>
                    <p>æœ‰æ•ˆæˆæƒç åˆ—è¡¨:</p>
                    <pre>${JSON.stringify(validLicenses, null, 2)}</pre>
                    
                    <h5>LicenseDistributor çŠ¶æ€:</h5>
                    <p>åˆ†å‘è®°å½•æ€»æ•°: ${distributedLicenses.length}</p>
                    <p>æ´»è·ƒæˆæƒç æ•°é‡: ${activeLicenses.length}</p>
                    <p>åˆ†å‘è®°å½•:</p>
                    <pre>${JSON.stringify(distributedLicenses, null, 2)}</pre>
                    
                    <h5>localStorage çŠ¶æ€:</h5>
                    <p>åˆ†å‘è®°å½•å­˜å‚¨:</p>
                    <pre>${localStorage.getItem('pairing_license_distribution') || 'æ— '}</pre>
                    <p>ç”¨æˆ·æˆæƒç å­˜å‚¨:</p>
                    <pre>${localStorage.getItem('user_licenses') || 'æ— '}</pre>
                </div>
            `;
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æˆæƒç æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰åˆ†å‘è®°å½•å’Œç”¨æˆ·æˆæƒç ã€‚')) {
                localStorage.removeItem('pairing_license_distribution');
                localStorage.removeItem('user_licenses');
                
                // é‡æ–°åˆå§‹åŒ–
                licenseManager.validLicenses.clear();
                licenseManager.loadValidLicenses();
                
                licenseDistributor.distributedLicenses = [];
                
                document.getElementById('clearResult').innerHTML = `
                    <div class="result">
                        <h4>âœ… æ•°æ®å·²æ¸…ç†</h4>
                        <p>æ‰€æœ‰æˆæƒç æ•°æ®å·²é‡ç½®</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            showCurrentState();
        });
    </script>
</body>
</html> 