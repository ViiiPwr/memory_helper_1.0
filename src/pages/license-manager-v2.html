<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæƒç ç®¡ç†ç³»ç»Ÿ V2 - é…å¯¹é¢˜ç”Ÿæˆå™¨</title>
    <script src="../js/license-manager-v2.js"></script>
    <style>
        body {
            font-family: "Segoe UI", "PingFang SC", "Hiragino Sans", Arial, sans-serif;
            padding: 2vw;
            background: #f8f9fa;
            color: #333;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 2rem;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .section h2 {
            color: #495057;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .license-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .license-table th,
        .license-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .license-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .license-table tr:hover {
            background: #f8f9fa;
        }

        .status-available {
            color: #27ae60;
            font-weight: bold;
        }

        .status-distributed {
            color: #f39c12;
            font-weight: bold;
        }

        .status-used {
            color: #e74c3c;
            font-weight: bold;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin: 1rem 0;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .license-code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ æˆæƒç ç®¡ç†ç³»ç»Ÿ V2</h1>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸ“Š æˆæƒç ç»Ÿè®¡</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æœç´¢åŠŸèƒ½ -->
        <div class="section">
            <h2>ğŸ” æœç´¢æˆæƒç </h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¾“å…¥æˆæƒç æˆ–å®¢æˆ·ä¿¡æ¯æœç´¢" />
                <button class="btn" onclick="searchLicenses()">æœç´¢</button>
                <button class="btn btn-warning" onclick="clearSearch()">æ¸…é™¤æœç´¢</button>
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- åˆ†å‘æˆæƒç  -->
        <div class="section">
            <h2>ğŸ“¤ åˆ†å‘æˆæƒç </h2>
            <div class="input-group">
                <label for="distributeLicenseInput">æˆæƒç ï¼š</label>
                <input type="text" id="distributeLicenseInput" placeholder="è¾“å…¥è¦åˆ†å‘çš„æˆæƒç " />
            </div>
            <div class="input-group">
                <label for="customerNameInput">å®¢æˆ·å§“åï¼š</label>
                <input type="text" id="customerNameInput" placeholder="å®¢æˆ·å§“å" />
            </div>
            <div class="input-group">
                <label for="customerContactInput">è”ç³»æ–¹å¼ï¼š</label>
                <input type="text" id="customerContactInput" placeholder="ç”µè¯/é‚®ç®±" />
            </div>
            <button class="btn btn-success" onclick="distributeLicense()">åˆ†å‘æˆæƒç </button>
            <button class="btn" onclick="getRandomAvailableLicense()">è·å–éšæœºå¯ç”¨æˆæƒç </button>
            <div id="distributeResult"></div>
        </div>

        <!-- æ ‡è®°ä½¿ç”¨ -->
        <div class="section">
            <h2>âœ… æ ‡è®°æˆæƒç ä½¿ç”¨</h2>
            <div class="input-group">
                <label for="markUsedInput">æˆæƒç ï¼š</label>
                <input type="text" id="markUsedInput" placeholder="è¾“å…¥è¦æ ‡è®°ä¸ºå·²ä½¿ç”¨çš„æˆæƒç " />
            </div>
            <button class="btn btn-warning" onclick="markAsUsed()">æ ‡è®°ä¸ºå·²ä½¿ç”¨</button>
            <div id="markUsedResult"></div>
        </div>

        <!-- å¯ç”¨æˆæƒç åˆ—è¡¨ -->
        <div class="section">
            <h2>ğŸ“‹ å¯ç”¨æˆæƒç åˆ—è¡¨</h2>
            <button class="btn" onclick="refreshAvailableLicenses()">åˆ·æ–°åˆ—è¡¨</button>
            <button class="btn btn-warning" onclick="exportAvailableLicenses()">å¯¼å‡ºå¯ç”¨æˆæƒç </button>
            <div id="availableLicensesList"></div>
            <div class="pagination" id="pagination"></div>
        </div>

        <!-- å·²åˆ†å‘æˆæƒç  -->
        <div class="section">
            <h2>ğŸ“¤ å·²åˆ†å‘æˆæƒç </h2>
            <button class="btn" onclick="refreshDistributedLicenses()">åˆ·æ–°åˆ—è¡¨</button>
            <button class="btn btn-warning" onclick="exportDistributedLicenses()">å¯¼å‡ºåˆ†å‘è®°å½•</button>
            <div id="distributedLicensesList"></div>
        </div>

        <!-- å·²ä½¿ç”¨æˆæƒç  -->
        <div class="section">
            <h2>âœ… å·²ä½¿ç”¨æˆæƒç </h2>
            <button class="btn" onclick="refreshUsedLicenses()">åˆ·æ–°åˆ—è¡¨</button>
            <button class="btn btn-warning" onclick="exportUsedLicenses()">å¯¼å‡ºä½¿ç”¨è®°å½•</button>
            <div id="usedLicensesList"></div>
        </div>

        <!-- ç³»ç»Ÿç®¡ç† -->
        <div class="section">
            <h2>âš™ï¸ ç³»ç»Ÿç®¡ç†</h2>
            <button class="btn btn-danger" onclick="resetSystem()">é‡ç½®ç³»ç»Ÿ</button>
            <button class="btn btn-warning" onclick="exportAllData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
            <div id="systemResult"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        const pageSize = 20;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshStats();
            refreshAvailableLicenses();
            refreshDistributedLicenses();
            refreshUsedLicenses();
        });

        // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
        function refreshStats() {
            const stats = licenseManagerV2.getStats();
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total.toLocaleString()}</div>
                    <div class="stat-label">æ€»æˆæƒç </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.available.toLocaleString()}</div>
                    <div class="stat-label">å¯ç”¨æˆæƒç </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.distributed.toLocaleString()}</div>
                    <div class="stat-label">å·²åˆ†å‘</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.used.toLocaleString()}</div>
                    <div class="stat-label">å·²ä½¿ç”¨</div>
                </div>
            `;
        }

        // æœç´¢æˆæƒç 
        function searchLicenses() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            const results = licenseManagerV2.searchLicenses(query);
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">æœªæ‰¾åˆ°åŒ¹é…çš„æˆæƒç </div>';
                return;
            }

            resultsDiv.innerHTML = `
                <h4>æœç´¢ç»“æœ (${results.length} ä¸ª)</h4>
                <table class="license-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æˆæƒç </th>
                            <th>çŠ¶æ€</th>
                            <th>å®¢æˆ·ä¿¡æ¯</th>
                            <th>åˆ†å‘æ—¶é—´</th>
                            <th>ä½¿ç”¨æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(license => `
                            <tr>
                                <td>${license.id}</td>
                                <td><span class="license-code">${license.code}</span></td>
                                <td><span class="status-${license.status}">${getStatusText(license.status)}</span></td>
                                <td>${license.customerInfo ? `${license.customerInfo.customer || ''} ${license.customerInfo.contact || ''}` : '-'}</td>
                                <td>${license.distributedAt ? new Date(license.distributedAt).toLocaleString() : '-'}</td>
                                <td>${license.usedAt ? new Date(license.usedAt).toLocaleString() : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // è·å–éšæœºå¯ç”¨æˆæƒç 
        function getRandomAvailableLicense() {
            const available = licenseManagerV2.getAvailableLicenses(1, 1);
            if (available.licenses.length > 0) {
                const randomLicense = available.licenses[0];
                document.getElementById('distributeLicenseInput').value = randomLicense.code;
            } else {
                alert('æ²¡æœ‰å¯ç”¨çš„æˆæƒç ');
            }
        }

        // åˆ†å‘æˆæƒç 
        function distributeLicense() {
            const licenseCode = document.getElementById('distributeLicenseInput').value.trim();
            const customerName = document.getElementById('customerNameInput').value.trim();
            const customerContact = document.getElementById('customerContactInput').value.trim();

            if (!licenseCode) {
                alert('è¯·è¾“å…¥æˆæƒç ');
                return;
            }

            const customerInfo = {
                customer: customerName,
                contact: customerContact
            };

            const result = licenseManagerV2.distributeLicense(licenseCode, customerInfo);
            
            if (result.success) {
                document.getElementById('distributeResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ${result.message}</strong><br>
                        æˆæƒç : ${result.licenseInfo.code}<br>
                        å®¢æˆ·: ${customerName || 'æœªæŒ‡å®š'}<br>
                        è”ç³»æ–¹å¼: ${customerContact || 'æœªæŒ‡å®š'}
                    </div>
                `;
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('distributeLicenseInput').value = '';
                document.getElementById('customerNameInput').value = '';
                document.getElementById('customerContactInput').value = '';
                
                // åˆ·æ–°åˆ—è¡¨
                refreshStats();
                refreshDistributedLicenses();
            } else {
                document.getElementById('distributeResult').innerHTML = `
                    <div class="alert alert-error">
                        <strong>âŒ ${result.message}</strong>
                    </div>
                `;
            }
        }

        // æ ‡è®°ä¸ºå·²ä½¿ç”¨
        function markAsUsed() {
            const licenseCode = document.getElementById('markUsedInput').value.trim();
            
            if (!licenseCode) {
                alert('è¯·è¾“å…¥æˆæƒç ');
                return;
            }

            const result = licenseManagerV2.markAsUsed(licenseCode);
            
            if (result.success) {
                document.getElementById('markUsedResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ${result.message}</strong><br>
                        æˆæƒç : ${result.licenseInfo.code}<br>
                        æ ‡è®°æ—¶é—´: ${new Date().toLocaleString()}
                    </div>
                `;
                
                document.getElementById('markUsedInput').value = '';
                refreshStats();
                refreshUsedLicenses();
            } else {
                document.getElementById('markUsedResult').innerHTML = `
                    <div class="alert alert-error">
                        <strong>âŒ ${result.message}</strong>
                    </div>
                `;
            }
        }

        // åˆ·æ–°å¯ç”¨æˆæƒç åˆ—è¡¨
        function refreshAvailableLicenses() {
            const result = licenseManagerV2.getAvailableLicenses(currentPage, pageSize);
            const listDiv = document.getElementById('availableLicensesList');
            
            if (result.licenses.length === 0) {
                listDiv.innerHTML = '<div class="alert alert-warning">æ²¡æœ‰å¯ç”¨çš„æˆæƒç </div>';
                return;
            }

            listDiv.innerHTML = `
                <h4>å¯ç”¨æˆæƒç  (ç¬¬ ${result.page} é¡µï¼Œå…± ${result.totalPages} é¡µ)</h4>
                <table class="license-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æˆæƒç </th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.licenses.map(license => `
                            <tr>
                                <td>${license.id}</td>
                                <td><span class="license-code">${license.code}</span></td>
                                <td>${new Date(license.createdAt).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-success" onclick="selectLicense('${license.code}')">é€‰æ‹©</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // æ›´æ–°åˆ†é¡µ
            updatePagination(result);
        }

        // åˆ·æ–°å·²åˆ†å‘æˆæƒç åˆ—è¡¨
        function refreshDistributedLicenses() {
            const distributedLicenses = licenseManagerV2.getDistributedLicenses();
            const listDiv = document.getElementById('distributedLicensesList');
            
            if (distributedLicenses.length === 0) {
                listDiv.innerHTML = '<div class="alert alert-warning">æ²¡æœ‰å·²åˆ†å‘çš„æˆæƒç </div>';
                return;
            }

            listDiv.innerHTML = `
                <h4>å·²åˆ†å‘æˆæƒç  (${distributedLicenses.length} ä¸ª)</h4>
                <table class="license-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æˆæƒç </th>
                            <th>å®¢æˆ·ä¿¡æ¯</th>
                            <th>åˆ†å‘æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${distributedLicenses.map(license => `
                            <tr>
                                <td>${license.id}</td>
                                <td><span class="license-code">${license.code}</span></td>
                                <td>${license.customerInfo ? `${license.customerInfo.customer || ''} ${license.customerInfo.contact || ''}` : '-'}</td>
                                <td>${new Date(license.distributedAt).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-warning" onclick="markAsUsed('${license.code}')">æ ‡è®°ä½¿ç”¨</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // åˆ·æ–°å·²ä½¿ç”¨æˆæƒç åˆ—è¡¨
        function refreshUsedLicenses() {
            const usedLicenses = licenseManagerV2.getUsedLicenses();
            const listDiv = document.getElementById('usedLicensesList');
            
            if (usedLicenses.length === 0) {
                listDiv.innerHTML = '<div class="alert alert-warning">æ²¡æœ‰å·²ä½¿ç”¨çš„æˆæƒç </div>';
                return;
            }

            listDiv.innerHTML = `
                <h4>å·²ä½¿ç”¨æˆæƒç  (${usedLicenses.length} ä¸ª)</h4>
                <table class="license-table">
                    <thead>
                        <tr>
                            <th>æˆæƒç </th>
                            <th>ä½¿ç”¨æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usedLicenses.map(code => `
                            <tr>
                                <td><span class="license-code">${code}</span></td>
                                <td>${new Date().toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(result) {
            const paginationDiv = document.getElementById('pagination');
            const pages = [];
            
            // ä¸Šä¸€é¡µ
            if (result.page > 1) {
                pages.push(`<button onclick="goToPage(${result.page - 1})">ä¸Šä¸€é¡µ</button>`);
            }
            
            // é¡µç 
            for (let i = Math.max(1, result.page - 2); i <= Math.min(result.totalPages, result.page + 2); i++) {
                pages.push(`<button class="${i === result.page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`);
            }
            
            // ä¸‹ä¸€é¡µ
            if (result.page < result.totalPages) {
                pages.push(`<button onclick="goToPage(${result.page + 1})">ä¸‹ä¸€é¡µ</button>`);
            }
            
            paginationDiv.innerHTML = pages.join('');
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToPage(page) {
            currentPage = page;
            refreshAvailableLicenses();
        }

        // é€‰æ‹©æˆæƒç 
        function selectLicense(code) {
            document.getElementById('distributeLicenseInput').value = code;
        }

        // å¯¼å‡ºåŠŸèƒ½
        function exportAvailableLicenses() {
            const result = licenseManagerV2.getAvailableLicenses(1, 1000);
            const data = result.licenses.map(l => ({ id: l.id, code: l.code }));
            downloadCSV(data, 'available_licenses.csv');
        }

        function exportDistributedLicenses() {
            const data = licenseManagerV2.getDistributedLicenses();
            downloadCSV(data, 'distributed_licenses.csv');
        }

        function exportUsedLicenses() {
            const data = licenseManagerV2.getUsedLicenses().map(code => ({ code }));
            downloadCSV(data, 'used_licenses.csv');
        }

        function exportAllData() {
            const data = licenseManagerV2.exportData();
            downloadJSON(data, 'license_data.json');
        }

        // é‡ç½®ç³»ç»Ÿ
        function resetSystem() {
            if (confirm('ç¡®å®šè¦é‡ç½®ç³»ç»Ÿå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰åˆ†å‘è®°å½•å’Œä½¿ç”¨è®°å½•ï¼Œæ‰€æœ‰æˆæƒç å°†æ¢å¤ä¸ºå¯ç”¨çŠ¶æ€ã€‚')) {
                licenseManagerV2.resetSystem();
                document.getElementById('systemResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ç³»ç»Ÿå·²é‡ç½®</strong><br>
                        æ‰€æœ‰æˆæƒç å·²æ¢å¤ä¸ºå¯ç”¨çŠ¶æ€
                    </div>
                `;
                refreshStats();
                refreshAvailableLicenses();
                refreshDistributedLicenses();
                refreshUsedLicenses();
            }
        }

        // å·¥å…·å‡½æ•°
        function getStatusText(status) {
            const statusMap = {
                'available': 'å¯ç”¨',
                'distributed': 'å·²åˆ†å‘',
                'used': 'å·²ä½¿ç”¨'
            };
            return statusMap[status] || status;
        }

        function downloadCSV(data, filename) {
            const csv = convertToCSV(data);
            downloadFile(csv, filename, 'text/csv');
        }

        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, filename, 'application/json');
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csv = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                });
                csv.push(values.join(','));
            });
            
            return csv.join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 