<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>配对卡片练习</title>
  <style>
    body {
      font-family: "Segoe UI", "PingFang SC", "Hiragino Sans", Arial,
        sans-serif;
      padding: 2vw;
      background: #f4f6fb;
      color: #222;
      margin: 0;
    }

    h1,
    h2 {
      color: #2a4d7a;
    }

    h1 {
      text-align: center;
    }

    input,
    textarea,
    button {
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #bbb;
      padding: 8px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    input:focus,
    textarea:focus {
      outline: 2px solid #4caf50;
    }

    button {
      background: #4caf50;
      color: #fff;
      border: none;
      margin-right: 10px;
      transition: background 0.2s;
    }

    button:hover {
      background: #388e3c;
    }

    .group-input {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0001;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .item {
      border: 1px solid #ccc;
      padding: 10px 16px;
      background: #e3f2fd;
      cursor: grab;
      user-select: none;
      border-radius: 6px;
      min-width: 80px;
      text-align: center;
      font-weight: 500;
      box-shadow: 0 1px 4px #0001;
    }

    .item.locked {
      cursor: not-allowed !important;
      opacity: 0.7;
    }

    .dropzone,
    .dropzone-col {
      border: 2px dashed #90caf9;
      min-height: 50px;
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 10px;
      min-width: 120px;
      transition: background 0.2s;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1 1 0;
    }

    .dropzone-col {
      border: none !important;
      background: none !important;
      min-height: 0 !important;
      padding: 0 !important;
      margin-bottom: 0 !important;
    }

    .dropzone.over {
      background: #e0ffe0;
    }

    .dropzone-wrapper {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .columns {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .question {
      flex: 1 1 220px;
      min-width: 220px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px #0001;
      padding: 12px;
      margin-bottom: 10px;
    }

    .result {
      margin-top: 5px;
      font-weight: bold;
      color: #388e3c;
    }

    #history {
      margin-top: 30px;
    }

    .history-item {
      margin-bottom: 10px;
      cursor: pointer;
      color: #1976d2;
      text-decoration: underline;
      font-size: 1.1em;
    }

    .history-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .history-card .edit-card:hover {
      background: #f57c00 !important;
    }

    .history-card .delete-card:hover {
      background: #d32f2f !important;
    }

    /* 确保检查答案时的颜色不被覆盖 */
    .item.correct {
      background-color: #4caf50 !important;
      border-color: #4caf50 !important;
    }

    .item.incorrect {
      background-color: #f44336 !important;
      border-color: #f44336 !important;
    }

    @media (max-width: 600px) {
      .columns {
        flex-direction: column;
        gap: 10px;
      }

      .question {
        min-width: unset;
      }

      .grid {
        flex-direction: column;
        gap: 6px;
      }

      .dropzone-wrapper {
        flex-direction: column !important;
        gap: 4px !important;
      }
    }
  </style>
</head>

<body>
  <h1>配对题练习</h1>
  <div style="margin-bottom: 10px; display: flex; justify-content: center">
    <label style="margin-right: 8px">题目名称：</label>
    <input type="text" id="cardSetTitle" required placeholder="请输入本卡组的题目名称" style="width: 60%; padding: 6px" />
    <span id="titleRequiredTip" style="color: #e53935; margin-left: 8px; display: none">*必填</span>
  </div>
  <div style="margin-bottom: 10px; display: flex; justify-content: center">
    <label style="margin-right: 8px">标签：</label>
    <input type="text" id="cardSetTags" placeholder="请输入标签，用逗号分隔（可选）" style="width: 60%; padding: 6px" />
  </div>
  <div id="groupContainer">
    <div class="group-input">
      <div style="flex: 1">
        <input type="text" placeholder="分组名称 (如：促进胃酸分泌的因素)" class="group-name"
          style="width: 100%; margin-bottom: 6px" />
        <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width: 100%; height: 60px"></textarea>
      </div>
      <button class="remove-group" style="background: #e57373">删除</button>
    </div>
  </div>
  <div style="
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 10px;
      ">
    <button id="addGroup">添加新分组</button>
    <button id="generate">生成配对题</button>
    <button id="newCard" style="background: #2196f3;">新建卡组</button>
  </div>

  <!-- Popup for review mode selection -->
  <div id="reviewModePopup" style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      ">
    <div style="
          background: #fff;
          padding: 32px 24px;
          border-radius: 12px;
          box-shadow: 0 4px 24px #0002;
          min-width: 240px;
          text-align: center;
        ">
      <div style="font-size: 1.1em; margin-bottom: 18px">请选择复习模式</div>
      <button id="reviewAllBtn" style="margin-bottom: 10px; width: 80%">
        全部打乱复习</button><br />
      <button id="reviewWrongBtn" style="background: #ff9800; width: 80%">
        只复习错题</button><br />
      <button id="cancelReviewBtn" style="margin-top: 10px; background: #bbb; width: 80%">
        取消
      </button>
    </div>
  </div>

  <div id="matchingArea"></div>
  <div style="display: flex; justify-content: center; margin-top: 10px">
    <button id="checkAnswers" style="display: none">检查答案</button>
    <button id="restartBtn" style="display: none; background: #ff9800; margin-left: 10px;">再来一遍</button>
  </div>

  <div id="history">
    <h2>历史卡组</h2>
    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <input type="text" id="searchTags" placeholder="输入标签搜索卡组" style="flex: 1; min-width: 200px; padding: 8px;" />
      <button id="searchBtn" style="background: #2196f3;">搜索</button>
      <button id="clearSearchBtn" style="background: #9e9e9e;">清除搜索</button>
    </div>
    <div id="historyList"></div>
  </div>

  <script>
    let allFactors = [];
    let correctAnswers = {};
    let history = [];
    let reviewModeCallback = null; // 用于popup回调

    // 洗牌函数
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // 优化分组输入区的添加和删除
    document
      .getElementById("addGroup")
      .addEventListener("click", function () {
        const container = document.getElementById("groupContainer");
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-input";
        groupDiv.style.display = "flex";
        groupDiv.style.gap = "10px";
        groupDiv.style.alignItems = "flex-start";
        groupDiv.innerHTML = `
                <div style="flex:1;">
                    <input type="text" placeholder="分组名称" class="group-name" style="width:100%;margin-bottom:6px;" />
                    <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width:100%;height:60px;"></textarea>
                </div>
                <button class="remove-group" style="background:#e57373;">删除</button>
            `;
        groupDiv.querySelector(".remove-group").onclick = function () {
          groupDiv.remove();
        };
        container.appendChild(groupDiv);
      });
    // 默认分组的删除按钮
    document.querySelector(".remove-group").onclick = function () {
      this.parentElement.remove();
    };

    document
      .getElementById("generate")
      .addEventListener("click", function () {
        const titleInput = document.getElementById("cardSetTitle");
        const titleTip = document.getElementById("titleRequiredTip");
        if (!titleInput.value.trim()) {
          titleTip.style.display = "inline";
          titleInput.focus();
          return;
        } else {
          titleTip.style.display = "none";
        }

        const groupNames = document.querySelectorAll(".group-name");
        const groupItems = document.querySelectorAll(".group-items");
        allFactors = [];
        correctAnswers = {};

        groupNames.forEach((nameInput, index) => {
          const groupName = nameInput.value.trim();
          if (!groupName) return;
          const items = groupItems[index].value
            .split(/[\n,]+/)
            .map((s) => s.trim())
            .filter((s) => s);
          items.forEach((item) => {
            allFactors.push({ text: item, group: groupName, correct: false });
          });
          correctAnswers[groupName] = items;
        });

        const cardSetTitle =
          titleInput.value.trim() || `卡组${history.length + 1}`;
        const tagsInput = document.getElementById("cardSetTags");
        const tags = tagsInput.value.trim()
          ? tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag)
          : [];

        history.push({
          title: cardSetTitle,
          tags: tags,
          factors: JSON.parse(JSON.stringify(allFactors)),
          correctAnswers: JSON.parse(JSON.stringify(correctAnswers)),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        saveHistory();
        renderHistory();
        renderMatchingArea(allFactors, correctAnswers);
      });

    function renderHistory(filteredHistory = null) {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      const displayHistory = filteredHistory || history;

      if (displayHistory.length === 0) {
        const noResultDiv = document.createElement("div");
        noResultDiv.style.textAlign = "center";
        noResultDiv.style.color = "#666";
        noResultDiv.style.padding = "20px";
        noResultDiv.textContent = filteredHistory ? "没有找到匹配的卡组" : "暂无历史卡组";
        historyList.appendChild(noResultDiv);
        return;
      }

      displayHistory.forEach((entry, index) => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "history-card";
        cardDiv.style.cssText = `
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        `;

        cardDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h3 style="margin: 0; color: #2a4d7a; font-size: 1.1em;">${entry.title || `卡组 ${index + 1}`}</h3>
            <div style="display: flex; gap: 5px;">
              <button class="edit-card" style="background: #ff9800; padding: 4px 8px; font-size: 0.8em; border: none; color: white; border-radius: 4px; cursor: pointer;">编辑</button>
              <button class="delete-card" style="background: #f44336; padding: 4px 8px; font-size: 0.8em; border: none; color: white; border-radius: 4px; cursor: pointer;">删除</button>
            </div>
          </div>
          <div style="margin-bottom: 8px;">
            ${entry.tags && entry.tags.length > 0 ?
            `<div style="display: flex; flex-wrap: wrap; gap: 4px;">
                ${entry.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 12px; font-size: 0.8em;">${tag}</span>`).join('')}
              </div>` :
            '<span style="color: #999; font-size: 0.9em;">无标签</span>'
          }
          </div>
          <div style="color: #666; font-size: 0.9em;">
            创建时间: ${new Date(entry.createdAt).toLocaleString()}
          </div>
        `;

        // 点击卡片进入复习模式
        cardDiv.addEventListener("click", (e) => {
          if (!e.target.classList.contains('edit-card') && !e.target.classList.contains('delete-card')) {
            const originalIndex = history.indexOf(entry);
            showReviewModePopup((mode) => chooseHistoryMode(originalIndex, mode));
          }
        });

        // 编辑按钮
        cardDiv.querySelector('.edit-card').addEventListener("click", (e) => {
          e.stopPropagation();
          editCard(entry, history.indexOf(entry));
        });

        // 删除按钮
        cardDiv.querySelector('.delete-card').addEventListener("click", (e) => {
          e.stopPropagation();
          deleteCard(history.indexOf(entry));
        });

        historyList.appendChild(cardDiv);
      });
    }

    // 新增：弹窗选择复习模式
    function showReviewModePopup(callback) {
      reviewModeCallback = callback;
      document.getElementById("reviewModePopup").style.display = "flex";
    }
    document.getElementById("reviewAllBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
      if (reviewModeCallback) reviewModeCallback("all");
    };
    document.getElementById("reviewWrongBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
      if (reviewModeCallback) reviewModeCallback("wrong");
    };
    document.getElementById("cancelReviewBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
    };

    function chooseHistoryMode(index, mode) {
      const entry = history[index];
      if (mode === "all") {
        // 打乱factors顺序
        const shuffled = shuffleArray(entry.factors.slice());
        allFactors = shuffled;
        correctAnswers = entry.correctAnswers;
        renderMatchingArea(shuffled, entry.correctAnswers);
      } else if (mode === "wrong") {
        const wrongFactors = entry.factors.filter((f) => f.correct === false);
        const wrongAnswers = {};
        Object.keys(entry.correctAnswers).forEach((groupName) => {
          const filtered = entry.correctAnswers[groupName].filter((item) =>
            wrongFactors.find((f) => f.text === item)
          );
          if (filtered.length > 0) wrongAnswers[groupName] = filtered;
        });
        if (Object.keys(wrongAnswers).length === 0) {
          alert("该卡组没有历史错题！");
          return;
        }
        allFactors = wrongFactors;
        correctAnswers = wrongAnswers;
        renderMatchingArea(wrongFactors, wrongAnswers);
      }
    }

    function renderMatchingArea(factors, answers) {
      const matchingArea = document.getElementById("matchingArea");
      matchingArea.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "grid";
      grid.id = "itemPool";

      factors.forEach((factor) => {
        const div = createDraggableItem(factor.text, factor.group);
        grid.appendChild(div);
      });

      matchingArea.appendChild(grid);

      const columns = document.createElement("div");
      columns.className = "columns";

      Object.keys(answers).forEach((groupName) => {
        const question = document.createElement("div");
        question.className = "question";
        question.innerHTML = `<strong>${groupName}：</strong>`;

        // dropzone wrapper
        const dropzoneWrapper = document.createElement("div");
        dropzoneWrapper.className = "dropzone-wrapper";

        // 主 dropzone
        const dropzone = document.createElement("div");
        dropzone.className = "dropzone";
        dropzone.dataset.group = groupName;

        enableDrop(dropzone);

        dropzoneWrapper.appendChild(dropzone);

        // 初次渲染时就分列
        splitDropzoneColumns(dropzone, dropzoneWrapper);

        // 结果区域
        const resultDiv = document.createElement("div");
        resultDiv.className = "result";
        resultDiv.id = "result-" + groupName;

        question.appendChild(dropzoneWrapper);
        question.appendChild(resultDiv);
        columns.appendChild(question);

        // --- 多栏分割 ---
        dropzone.addEventListener("DOMSubtreeModified", function () {
          splitDropzoneColumns(dropzone, dropzoneWrapper);
        });
      });

      matchingArea.appendChild(columns);

      document.getElementById("checkAnswers").style.display = "inline-block";
    }

    // 多栏分割逻辑
    function splitDropzoneColumns(dropzone, wrapper) {
      if (!dropzone || !wrapper) return;
      // 收集所有 item
      let items = [];
      wrapper.querySelectorAll(".dropzone, .dropzone-col").forEach((col) => {
        items = items.concat(Array.from(col.children));
      });
      // 清空 wrapper
      wrapper.innerHTML = "";

      // 计算栏数
      let colCount = 1;
      if (items.length > 3) colCount = 2;
      if (items.length > 6) colCount = 3;
      if (items.length > 12) colCount = 4;

      // 分配到多栏
      const columns = Array.from({ length: colCount }, () => []);
      items.forEach((item, idx) => {
        columns[idx % colCount].push(item);
      });

      // 创建新栏
      for (let i = 0; i < colCount; i++) {
        const colDiv = document.createElement("div");
        colDiv.className = i === 0 ? "dropzone" : "dropzone-col";
        colDiv.style.display = "flex";
        colDiv.style.flexDirection = "column";
        colDiv.style.flex = "1 1 0";
        colDiv.style.gap = "4px";
        colDiv.style.minWidth = "60px";
        columns[i].forEach((item) => colDiv.appendChild(item));
        // 只主栏可拖拽
        if (i === 0) enableDrop(colDiv);
        wrapper.appendChild(colDiv);
      }
    }

    function createDraggableItem(text, group) {
      const div = document.createElement("div");
      div.className = "item";
      div.draggable = true;
      div.textContent = text;
      div.dataset.group = group;

      div.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ text, group }));
      });

      return div;
    }

    function enableDrop(dropzone) {
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("over");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("over");
      });

      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("over");
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));

        removeItemFromAll(data.text);

        const itemDiv = createDraggableItem(data.text, data.group);
        dropzone.appendChild(itemDiv);
      });
    }

    document.addEventListener("dragend", function (e) {
      const itemPool = document.getElementById("itemPool");
      if (e.target.classList.contains("item")) {
        const rect = itemPool.getBoundingClientRect();
        if (
          e.pageX >= rect.left &&
          e.pageX <= rect.right &&
          e.pageY >= rect.top &&
          e.pageY <= rect.bottom
        ) {
          removeItemFromAll(e.target.textContent);
          itemPool.appendChild(e.target);
        }
      }
    });

    function removeItemFromAll(text) {
      document.querySelectorAll(".item").forEach((item) => {
        if (item.textContent === text) {
          item.remove();
        }
      });
    }

    document
      .getElementById("checkAnswers")
      .addEventListener("click", function () {
        // 重置所有item的颜色
        document.querySelectorAll(".item").forEach((item) => {
          item.classList.remove("correct", "incorrect");
        });

        // 隐藏"再来一遍"按钮
        document.getElementById("restartBtn").style.display = "none";

        Object.keys(correctAnswers).forEach((groupName) => {
          // 最简单的方法：直接查找所有在分类区域内的item
          const allItems = document.querySelectorAll('.item');
          let items = [];

          // 找到所有不在itemPool中的item（即已经拖入分类区域的item）
          allItems.forEach(item => {
            const parent = item.parentElement;
            // 检查item是否在分类区域内（不在itemPool中）
            if (parent && !parent.id.includes('itemPool')) {
              // 检查这个item是否在当前分类的区域内
              const questionDiv = parent.closest('.question');
              if (questionDiv) {
                const questionTitle = questionDiv.querySelector('strong');
                if (questionTitle && questionTitle.textContent.includes(groupName)) {
                  items.push(item);
                }
              }
            }
          });

          // 调试信息
          console.log(`[${groupName}] 找到 ${items.length} 个item:`, items.map(item => item.textContent));

          // 获取该分类的正确答案集合
          const correctSet = new Set(correctAnswers[groupName]);
          let correctCount = 0;
          let answeredCount = 0;

          items.forEach((item) => {
            answeredCount++;
            // 根据item原本所属的类别判断正确性
            const itemOriginalGroup = item.dataset.group;
            const isCorrect = itemOriginalGroup === groupName;



            if (isCorrect) {
              item.classList.add("correct");
              item.classList.remove("incorrect");
              correctCount++;
            } else {
              item.classList.add("incorrect");
              item.classList.remove("correct");
            }

            // 更新allFactors中的正确性状态
            allFactors.forEach((f) => {
              if (f.text === item.textContent) {
                f.correct = isCorrect;
              }
            });
          });

          const resultDiv = document.getElementById("result-" + groupName);
          if (answeredCount > 0) {
            resultDiv.textContent = `已作答：${answeredCount}个，正确：${correctCount}个 / 总计：${correctAnswers[groupName].length}个`;
          } else {
            resultDiv.textContent = `未作答 / 总计：${correctAnswers[groupName].length}个`;
          }
        });

        // 覆盖同步到历史卡组
        history.forEach((entry) => {
          entry.factors.forEach((f) => {
            const updated = allFactors.find((af) => af.text === f.text);
            if (updated) f.correct = updated.correct;
          });
        });
        saveHistory();

        // 新增：如果所有item都被拖入分类栏，则锁定所有分类栏内的item，并显示"再来一遍"按钮
        const itemPool = document.getElementById("itemPool");
        if (itemPool && itemPool.children.length === 0) {
          document.querySelectorAll('.question .item').forEach(item => {
            item.draggable = false;
            item.classList.add('locked');
          });
          // 显示"再来一遍"按钮
          document.getElementById("restartBtn").style.display = "inline-block";
        }
      });

    function saveHistory() {
      localStorage.setItem("cardGroupHistory", JSON.stringify(history));
    }

    function backupHistory() {
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
      const key = "cardGroupHistory_backup_" + dateStr;
      localStorage.setItem(key, JSON.stringify(history));
    }

    // 启动时立即备份一次
    backupHistory();
    // 每24小时备份一次
    setInterval(backupHistory, 24 * 60 * 60 * 1000);

    // 编辑卡组功能
    function editCard(entry, index) {
      // 填充表单
      document.getElementById("cardSetTitle").value = entry.title || "";
      document.getElementById("cardSetTags").value = entry.tags ? entry.tags.join(", ") : "";

      // 清空现有分组
      const container = document.getElementById("groupContainer");
      container.innerHTML = "";

      // 重新创建分组
      Object.keys(entry.correctAnswers).forEach((groupName, groupIndex) => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-input";
        groupDiv.style.display = "flex";
        groupDiv.style.gap = "10px";
        groupDiv.style.alignItems = "flex-start";
        groupDiv.innerHTML = `
          <div style="flex:1;">
            <input type="text" placeholder="分组名称" class="group-name" style="width:100%;margin-bottom:6px;" value="${groupName}" />
            <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width:100%;height:60px;">${entry.correctAnswers[groupName].join(", ")}</textarea>
          </div>
          <button class="remove-group" style="background:#e57373;">删除</button>
        `;
        groupDiv.querySelector(".remove-group").onclick = function () {
          groupDiv.remove();
        };
        container.appendChild(groupDiv);
      });

      // 修改生成按钮行为为更新
      const generateBtn = document.getElementById("generate");
      generateBtn.textContent = "更新卡组";
      generateBtn.onclick = function () {
        updateCard(index);
      };

      // 滚动到顶部
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 更新卡组
    function updateCard(index) {
      const titleInput = document.getElementById("cardSetTitle");
      const titleTip = document.getElementById("titleRequiredTip");
      if (!titleInput.value.trim()) {
        titleTip.style.display = "inline";
        titleInput.focus();
        return;
      } else {
        titleTip.style.display = "none";
      }

      const groupNames = document.querySelectorAll(".group-name");
      const groupItems = document.querySelectorAll(".group-items");
      const newFactors = [];
      const newCorrectAnswers = {};

      groupNames.forEach((nameInput, groupIndex) => {
        const groupName = nameInput.value.trim();
        if (!groupName) return;
        const items = groupItems[groupIndex].value
          .split(/[\n,]+/)
          .map((s) => s.trim())
          .filter((s) => s);
        items.forEach((item) => {
          newFactors.push({ text: item, group: groupName, correct: false });
        });
        newCorrectAnswers[groupName] = items;
      });

      const cardSetTitle = titleInput.value.trim();
      const tagsInput = document.getElementById("cardSetTags");
      const tags = tagsInput.value.trim()
        ? tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag)
        : [];

      // 更新历史记录
      history[index] = {
        title: cardSetTitle,
        tags: tags,
        factors: JSON.parse(JSON.stringify(newFactors)),
        correctAnswers: JSON.parse(JSON.stringify(newCorrectAnswers)),
        createdAt: history[index].createdAt,
        updatedAt: new Date().toISOString()
      };

      saveHistory();
      renderHistory();

      // 重置表单和按钮
      resetForm();

      alert("卡组更新成功！");
    }

    // 删除卡组
    function deleteCard(index) {
      if (confirm("确定要删除这个卡组吗？此操作不可撤销。")) {
        history.splice(index, 1);
        saveHistory();
        renderHistory();
        alert("卡组已删除！");
      }
    }

    // 搜索功能
    document.getElementById("searchBtn").addEventListener("click", function () {
      const searchTerm = document.getElementById("searchTags").value.trim().toLowerCase();
      if (!searchTerm) {
        renderHistory();
        return;
      }

      const filteredHistory = history.filter(entry => {
        // 搜索标题
        if (entry.title && entry.title.toLowerCase().includes(searchTerm)) {
          return true;
        }
        // 搜索标签
        if (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchTerm))) {
          return true;
        }
        return false;
      });

      renderHistory(filteredHistory);
    });

    // 清除搜索
    document.getElementById("clearSearchBtn").addEventListener("click", function () {
      document.getElementById("searchTags").value = "";
      renderHistory();
    });

    // 新建卡组按钮
    document.getElementById("newCard").addEventListener("click", function () {
      resetForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // 再来一遍按钮
    document.getElementById("restartBtn").addEventListener("click", function () {
      showReviewModePopup((mode) => {
        if (mode === "all") {
          // 全部打乱复习
          const shuffled = shuffleArray(allFactors.slice());
          renderMatchingArea(shuffled, correctAnswers);
          // 隐藏"再来一遍"按钮
          document.getElementById("restartBtn").style.display = "none";
        } else if (mode === "wrong") {
          // 只复习错题
          const wrongFactors = allFactors.filter((f) => f.correct === false);
          const wrongAnswers = {};
          Object.keys(correctAnswers).forEach((groupName) => {
            const filtered = correctAnswers[groupName].filter((item) =>
              wrongFactors.find((f) => f.text === item)
            );
            if (filtered.length > 0) wrongAnswers[groupName] = filtered;
          });
          if (Object.keys(wrongAnswers).length === 0) {
            alert("没有错题需要复习！");
            return;
          }
          renderMatchingArea(wrongFactors, wrongAnswers);
          // 隐藏"再来一遍"按钮
          document.getElementById("restartBtn").style.display = "none";
        }
      });
    });

    // 重置表单
    function resetForm() {
      document.getElementById("cardSetTitle").value = "";
      document.getElementById("cardSetTags").value = "";
      document.getElementById("groupContainer").innerHTML = `
        <div class="group-input">
          <div style="flex: 1">
            <input type="text" placeholder="分组名称 (如：促进胃酸分泌的因素)" class="group-name"
              style="width: 100%; margin-bottom: 6px" />
            <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width: 100%; height: 60px"></textarea>
          </div>
          <button class="remove-group" style="background: #e57373">删除</button>
        </div>
      `;

      // 重新绑定删除按钮
      document.querySelector(".remove-group").onclick = function () {
        this.parentElement.remove();
      };

      // 重置生成按钮
      const generateBtn = document.getElementById("generate");
      generateBtn.textContent = "生成配对题";
      generateBtn.onclick = function () {
        // 恢复原来的生成逻辑
        const titleInput = document.getElementById("cardSetTitle");
        const titleTip = document.getElementById("titleRequiredTip");
        if (!titleInput.value.trim()) {
          titleTip.style.display = "inline";
          titleInput.focus();
          return;
        } else {
          titleTip.style.display = "none";
        }

        const groupNames = document.querySelectorAll(".group-name");
        const groupItems = document.querySelectorAll(".group-items");
        allFactors = [];
        correctAnswers = {};

        groupNames.forEach((nameInput, index) => {
          const groupName = nameInput.value.trim();
          if (!groupName) return;
          const items = groupItems[index].value
            .split(/[\n,]+/)
            .map((s) => s.trim())
            .filter((s) => s);
          items.forEach((item) => {
            allFactors.push({ text: item, group: groupName, correct: false });
          });
          correctAnswers[groupName] = items;
        });

        const cardSetTitle =
          titleInput.value.trim() || `卡组${history.length + 1}`;
        const tagsInput = document.getElementById("cardSetTags");
        const tags = tagsInput.value.trim()
          ? tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag)
          : [];

        history.push({
          title: cardSetTitle,
          tags: tags,
          factors: JSON.parse(JSON.stringify(allFactors)),
          correctAnswers: JSON.parse(JSON.stringify(correctAnswers)),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        saveHistory();
        renderHistory();
        renderMatchingArea(allFactors, correctAnswers);
      };
    }

    // 加载历史卡组时自动恢复
    const saved = localStorage.getItem("cardGroupHistory");
    if (saved) {
      history = JSON.parse(saved);
      renderHistory();
    }
  </script>
</body>

</html>