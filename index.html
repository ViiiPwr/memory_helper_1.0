<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>学成选择题——配对卡片练习</title>

  <!-- 本地存储管理器 -->
  <script src="src/js/local-storage.js"></script>
  <!-- 授权码管理器 -->
  <script src="src/js/license-manager.js"></script>

  <!-- 云托管环境下的云开发初始化 -->
  <script>
    // 全局变量声明
    let allFactors = [];
    let correctAnswers = {};
    let history = [];
    let currentTags = [];
    let historyTags = [];
    let currentUser = null;
    let reviewModeCallback = null;

    // 本地存储管理器检测
    console.log('=== 本地存储管理器检测 ===');
    console.log('LocalStorageManager:', typeof LocalStorageManager !== 'undefined' ? '✅ 已加载' : '❌ 未加载');

    // 本地存储管理器初始化
    // 注意：localStorageManager已在local-storage.js中创建

    // 初始化本地存储
    async function initLocalStorage() {
      try {
        if (typeof localStorageManager !== 'undefined') {
          console.log('✅ 本地存储管理器已可用');
          return true;
        } else {
          console.warn('本地存储管理器未加载，使用基础localStorage');
          return false;
        }
      } catch (error) {
        console.error('❌ 本地存储初始化失败:', error);
        return false;
      }
    }

    // 检查本地存储是否可用
    async function isLocalStorageAvailable() {
      try {
        const testKey = 'test_storage';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch (error) {
        console.error('本地存储不可用:', error);
        return false;
      }
    }

    // 兼容性包装器 - 保持原有的cloudDB接口
    if (typeof cloudDB === 'undefined') {
      window.cloudDB = {
        isAvailable: () => true,
        saveUser: async (userData) => {
          return await localStorageManager.saveUser(userData);
        },
        getUser: async (userId) => {
          return await localStorageManager.getUser(userId);
        },
        saveCardSets: async (userId, cardSets) => {
          return await localStorageManager.saveCardSets(userId, cardSets);
        },
        getCardSets: async (userId) => {
          return await localStorageManager.getCardSets(userId);
        },
        saveHistoryTags: async (userId, tags) => {
          return await localStorageManager.saveHistoryTags(userId, tags);
        },
        getHistoryTags: async (userId) => {
          return await localStorageManager.getHistoryTags(userId);
        },
        migrateFromLocalStorage: async (userId) => {
          return await localStorageManager.migrateFromLegacyFormat(userId);
        }
      };
    }

    // 全局测试函数
    window.testLocalStorage = async function () {
      console.log('=== 本地存储测试 ===');

      // 1. 检查本地存储管理器
      console.log('1. 本地存储管理器检查:');
      console.log('  LocalStorageManager:', typeof LocalStorageManager !== 'undefined' ? '✅' : '❌');
      console.log('  localStorageManager:', typeof localStorageManager !== 'undefined' ? '✅' : '❌');

      // 2. 检查兼容性接口
      console.log('2. 兼容性接口检查:');
      console.log('  cloudDB (兼容性):', typeof cloudDB !== 'undefined' ? '✅' : '❌');

      // 3. 测试本地存储可用性
      console.log('3. 本地存储可用性测试:');
      try {
        const isAvailable = await isLocalStorageAvailable();
        console.log('  ✅ 本地存储可用:', isAvailable);
      } catch (error) {
        console.log('  ❌ 本地存储不可用:', error.message);
      }

      // 4. 测试存储信息
      if (typeof localStorageManager !== 'undefined') {
        console.log('4. 存储信息:');
        try {
          const storageInfo = localStorageManager.getStorageInfo();
          console.log('  总大小:', storageInfo.totalSizeFormatted);
          console.log('  项目数量:', storageInfo.itemCount);
          console.log('  存储项目:', storageInfo.items);
        } catch (error) {
          console.log('  ❌ 获取存储信息失败:', error.message);
        }
      }

      console.log('=== 测试完成 ===');
    };
  </script>
  <style>
    body {
      font-family: "Segoe UI", "PingFang SC", "Hiragino Sans", Arial,
        sans-serif;
      padding: 2vw;
      background: #f8f9fa;
      color: #333;
      margin: 0;
    }

    h1,
    h2 {
      color: #2c3e50;
    }

    h1 {
      text-align: center;
    }

    input,
    textarea,
    button {
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #bbb;
      padding: 8px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    input:focus,
    textarea:focus {
      outline: 2px solid #3498db;
    }

    button {
      background: #3498db;
      color: #fff;
      border: none;
      margin-right: 10px;
      transition: background 0.2s;
    }

    button:hover {
      background: #2980b9;
    }

    .group-input {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .item {
      border: 1px solid #ddd;
      padding: 10px 16px;
      background: #ecf0f1;
      cursor: grab;
      user-select: none;
      border-radius: 6px;
      min-width: 80px;
      text-align: center;
      font-weight: 500;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .item.locked {
      cursor: not-allowed !important;
      opacity: 0.7;
    }

    /* Toast 消息样式 */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      pointer-events: none;
    }

    /* 确认对话框样式 */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .confirm-dialog .dialog-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
    }

    .confirm-dialog .dialog-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    .confirm-dialog button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .confirm-dialog .btn-cancel {
      background: #9e9e9e;
      color: white;
    }

    .confirm-dialog .btn-confirm {
      background: #f44336;
      color: white;
    }

    /* 区域分隔样式 */
    .section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      color: #2c3e50;
      font-size: 1.4em;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #ecf0f1;
      display: flex;
      align-items: center;
    }

    .section-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: #3498db;
      margin-right: 12px;
      border-radius: 2px;
    }

    .section-content {
      margin-top: 16px;
    }

    /* 标签样式 */
    .tag {
      background: #ecf0f1;
      color: #2c3e50;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid #bdc3c7;
      transition: all 0.2s;
    }

    .tag:hover {
      background: #d5dbdb;
      transform: translateY(-1px);
    }

    .tag .remove-tag {
      background: none;
      border: none;
      color: #2c3e50;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
      margin: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .tag .remove-tag:hover {
      background: #2c3e50;
      color: white;
    }

    /* 历史标签删除按钮样式 */
    .tag.selectable .remove-tag {
      color: #7f8c8d;
      opacity: 0.7;
    }

    .tag.selectable .remove-tag:hover {
      background: #e74c3c;
      color: white;
      opacity: 1;
    }

    /* 可选标签区样式 */
    .tag.selectable {
      background: #f8f9fa;
      color: #2c3e50;
      border: 1px dashed #bdc3c7;
      cursor: pointer;
      opacity: 0.85;
    }

    .tag.selectable.selected {
      background: #3498db;
      color: #fff;
      border: 1px solid #3498db;
      opacity: 1;
    }

    .toast {
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      pointer-events: auto;
      max-width: 300px;
      word-wrap: break-word;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #f44336;
    }

    .toast.warning {
      background: #ff9800;
    }

    .dropzone,
    .dropzone-col {
      border: 2px dashed #bdc3c7;
      min-height: 50px;
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 10px;
      min-width: 120px;
      transition: background 0.2s;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1 1 0;
    }

    .dropzone-col {
      border: none !important;
      background: none !important;
      min-height: 0 !important;
      padding: 0 !important;
      margin-bottom: 0 !important;
    }

    .dropzone.over {
      background: #e8f4fd;
    }

    .dropzone-wrapper {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .columns {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .question {
      flex: 1 1 220px;
      min-width: 220px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      margin-bottom: 10px;
    }

    .result {
      margin-top: 5px;
      font-weight: bold;
      color: #27ae60;
    }

    #history {
      margin-top: 30px;
    }

    .history-item {
      margin-bottom: 10px;
      cursor: pointer;
      color: #3498db;
      text-decoration: underline;
      font-size: 1.1em;
    }

    .history-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .history-card .edit-card:hover {
      background: #d35400 !important;
    }

    .history-card .delete-card:hover {
      background: #7f8c8d !important;
    }

    /* 确保检查答案时的颜色不被覆盖 */
    .item.correct {
      background-color: #27ae60 !important;
      border-color: #27ae60 !important;
    }

    .item.incorrect {
      background-color: #e74c3c !important;
      border-color: #e74c3c !important;
    }

    .main-title-bg {
      background: linear-gradient(90deg, #e3f0fc 0%, #d2f6e9 100%);
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(52, 152, 219, 0.08);
      padding: 28px 0 18px 0;
      margin: 0 auto 32px auto;
      max-width: 700px;
      text-align: center;
    }

    .main-title-bg h1 {
      margin: 0;
      font-size: 2.2rem;
      color: #2176ae;
      letter-spacing: 2px;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(52, 152, 219, 0.08);
    }

    .text-btn {
      background: none;
      border: none;
      color: #3498db;
      font-size: 15px;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .text-btn:hover {
      background: #e3f0fc;
    }

    .help-tooltip {
      position: absolute;
      top: 56px;
      right: 32px;
      z-index: 2000;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 24px #0002;
      padding: 0;
      min-width: 260px;
      max-width: 320px;
      border: 1px solid #e3f0fc;
      animation: fadeIn 0.2s;
    }

    .help-tooltip-content {
      padding: 18px 20px 12px 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 600px) {
      .columns {
        flex-direction: column;
        gap: 10px;
      }

      .question {
        min-width: unset;
      }

      .grid {
        flex-direction: column;
        gap: 6px;
      }

      .dropzone-wrapper {
        flex-direction: column !important;
        gap: 4px !important;
      }
    }
  </style>
</head>

<body>
  <!-- 授权验证界面 -->
  <div id="authOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  ">
    <div style="
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    ">
      <h2 style="color: #2c3e50; margin-bottom: 20px;">欢迎使用配对题生成器</h2>
      <p style="color: #666; margin-bottom: 20px;">请输入授权码以继续使用</p>
      <input type="text" id="authCodeInput" placeholder="请输入授权码" style="
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        margin-bottom: 20px;
        box-sizing: border-box;
      ">
      <button id="authSubmitBtn" style="
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
      ">验证授权码</button>
    </div>
  </div>

  <!-- 用户信息栏 -->
  <div id="userInfoBar" style="
    display: none;
    background: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  ">
    <div>
      <span style="color: #2c3e50; font-weight: 500;">用户ID: </span>
      <span id="currentUserId" style="color: #3498db;"></span>
    </div>
    <div style="display: flex; align-items: center; gap: 12px;">
      <button id="helpBtn" class="text-btn" type="button">使用教程</button>
      <button id="licenseBtn" class="text-btn" type="button" style="color: #e74c3c;">🔑 授权码管理</button>
      <button id="logoutBtn" style="
        background: #95a5a6;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      ">退出登录</button>
    </div>
    <div id="helpTooltip" class="help-tooltip" style="display:none;">
      <div class="help-tooltip-content">
        <div style="font-weight:bold; margin-bottom:6px;">使用教程</div>
        <div style="text-align:left; font-size:14px; line-height:1.7;">
          1. 输入授权码登录，数据自动隔离。<br>
          2. 创建新卡组，填写题目名称、标签、分组和条目。<br>
          3. 生成配对题后可在历史卡组中查找、编辑、删除。<br>
          4. 点击历史卡组可进入复习模式，支持多次检查答案。<br>
          5. 标签可多选，支持常用标签快捷选择。<br>
          6. 退出登录后，数据不会丢失。<br>
          7. 如有问题，欢迎反馈！
        </div>
        <button id="closeHelpTooltip" class="text-btn" style="margin-top:10px;">关闭</button>
      </div>
    </div>
  </div>

  <div class="main-title-bg">
    <h1>学成选择题——配对卡片练习</h1>
  </div>

  <!-- 添加卡组区域 -->
  <div class="section">
    <div class="section-title">创建新卡组</div>
    <div class="section-content">
      <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center">
        <label style="width: 80px; text-align: right; margin-right: 8px; white-space: nowrap;">题目名称：</label>
        <input type="text" id="cardSetTitle" required placeholder="请输入本卡组的题目名称" style="width: 300px; padding: 6px" />
        <span id="titleRequiredTip" style="color: #e74c3c; margin-left: 8px; display: none">*必填</span>
      </div>
      <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center">
        <label style="width: 80px; text-align: right; margin-right: 8px; white-space: nowrap;">标签：</label>
        <input type="text" id="cardSetTags" placeholder="输入标签后按回车或逗号添加" style="width: 300px; padding: 6px" />
      </div>
      <div id="tagsDisplay" style="margin-bottom: 8px; display: flex; justify-content: center;">
        <div id="tagsContainer"
          style="display: flex; flex-wrap: wrap; gap: 6px; max-width: 60%; max-height: 80px; overflow: hidden;"></div>
      </div>
      <!-- 可选历史标签区 -->
      <div id="historyTagsDisplay" style="margin-bottom: 15px; display: flex; justify-content: center;">
        <div id="historyTagsContainer"
          style="display: flex; flex-wrap: wrap; gap: 6px; max-width: 60%; max-height: 80px; overflow: hidden;"></div>
      </div>
      <div id="groupContainer">
        <div class="group-input">
          <div style="flex: 1">
            <input type="text" placeholder="分组名称 (如：促进胃酸分泌的因素)" class="group-name"
              style="width: 100%; margin-bottom: 6px" />
            <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width: 100%; height: 60px"></textarea>
          </div>
          <button class="remove-group" style="background: #95a5a6">删除</button>
        </div>
      </div>
      <div style="
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
          ">
        <button id="addGroup" style="background: #e67e22;">添加新分组</button>
        <button id="generate">生成配对题</button>
        <button id="newCard" style="background: #95a5a6;" title="清空所有输入，准备新建卡组">清空</button>
      </div>
    </div>
  </div>

  <!-- Popup for review mode selection -->
  <div id="reviewModePopup" style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      ">
    <div style="
          background: #fff;
          padding: 32px 24px;
          border-radius: 12px;
          box-shadow: 0 4px 24px #0002;
          min-width: 240px;
          text-align: center;
        ">
      <div style="font-size: 1.1em; margin-bottom: 18px">请选择复习模式</div>
      <button id="reviewAllBtn" style="margin-bottom: 10px; width: 80%">
        全部打乱复习</button><br />
      <button id="reviewWrongBtn" style="background: #e67e22; width: 80%">
        只复习错题</button><br />
      <button id="cancelReviewBtn" style="margin-top: 10px; background: #95a5a6; width: 80%">
        取消
      </button>
    </div>
  </div>

  <!-- 复习区域 -->
  <div class="section" id="reviewSection" style="display: none;">
    <div class="section-title">配对练习</div>
    <div class="section-content">
      <div id="matchingArea"></div>
      <div style="display: flex; justify-content: center; margin-top: 10px">
        <button id="checkAnswers" style="display: none">检查答案</button>
        <button id="restartBtn" style="display: none; margin-left: 10px;">再来一遍</button>
      </div>
    </div>
  </div>

  <!-- Toast 消息容器 -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- 历史卡组区域 -->
  <div class="section" id="history">
    <div class="section-title">历史卡组</div>
    <div class="section-content">
      <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="searchTags" placeholder="输入标签搜索卡组" style="flex: 1; min-width: 200px; padding: 8px;" />
        <button id="searchBtn">搜索</button>
        <button id="clearSearchBtn" style="background: #95a5a6;">清除搜索</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    // 用户数据管理
    // 初始化用户系统
    async function initUserSystem() {
      // 检查是否已登录
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainInterface();
        await initUserData(); // 初始化用户数据
      } else {
        showAuthInterface();
      }
    }

    initUserSystem();
    // 启动时加载历史标签池
    (async function () {
      await loadHistoryTags();
      renderHistoryTags();
    })();

    // 显示授权界面
    function showAuthInterface() {
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('userInfoBar').style.display = 'none';
      document.querySelector('h1').style.display = 'none';
      document.querySelector('.section').style.display = 'none';
    }

    // 显示主界面
    function showMainInterface() {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('userInfoBar').style.display = 'flex';
      document.querySelector('h1').style.display = 'block';
      document.querySelector('.section').style.display = 'block';
      document.getElementById('currentUserId').textContent = currentUser.userId;
    }

    // 验证授权码（集成授权码验证）
    async function validateAuthCode(code) {
      if (!code || !code.trim()) {
        showToast('请输入授权码', 'error');
        return false;
      }

      // 使用授权码管理器验证
      const validationResult = licenseManager.validateLicense(code.trim());
      
      if (validationResult.valid) {
        // 获取授权码信息
        const licenseInfo = licenseManager.getLicenseInfo(code.trim());
        
        // 设置用户信息
        currentUser = {
          userId: code.trim(),
          authCode: code.trim(),
          licenseType: licenseInfo.type,
          licenseName: licenseInfo.name,
          loginTime: new Date().toISOString()
        };

        try {
          // 保存用户信息到本地存储
          await cloudDB.saveUser(currentUser);
          console.log('用户信息已保存到本地存储');
        } catch (error) {
          console.error('保存用户信息失败:', error);
          // 直接保存到localStorage
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        // 显示主界面
        showMainInterface();

        // 初始化用户数据
        await initUserData();

        // 尝试迁移旧格式数据
        setTimeout(() => {
          migrateDataToCloud();
        }, 1000);

        showToast(`授权成功！${licenseInfo.name} - ${licenseInfo.features.join(', ')}`, 'success');
        return true;
      } else {
        showToast(validationResult.message, 'error');
        return false;
      }
    }

    // 初始化用户数据
    async function initUserData() {
      // 清空现有数据
      allFactors = [];
      correctAnswers = {};
      history = [];
      historyTags = [];

      // 加载用户数据
      await loadUserData();

      // 渲染界面
      renderHistory();
      renderHistoryTags();
    }

    // 加载用户数据
    async function loadUserData() {
      if (!currentUser) return;

      try {
        // 从本地存储加载数据
        const cardSets = await cloudDB.getCardSets(currentUser.userId);
        const tags = await cloudDB.getHistoryTags(currentUser.userId);

        history = cardSets || [];
        historyTags = tags || [];

        // 渲染数据
        renderHistory();
        renderHistoryTags();

        console.log('✅ 数据已从本地存储加载');
      } catch (error) {
        console.error('❌ 从本地存储加载数据失败:', error);
        // 尝试从旧格式加载
        const userHistory = localStorage.getItem(`history_${currentUser.userId}`);
        if (userHistory) {
          history = JSON.parse(userHistory);
        }
        const savedTags = localStorage.getItem(`cardSetHistoryTags_${currentUser.userId}`);
        if (savedTags) {
          historyTags = JSON.parse(savedTags);
        }
        renderHistory();
        renderHistoryTags();
        console.log('✅ 数据已从旧格式加载');
      }
    }

    // 保存用户数据
    async function saveUserData() {
      if (!currentUser) return;

      try {
        // 保存到本地存储
        await cloudDB.saveCardSets(currentUser.userId, history);
        await cloudDB.saveHistoryTags(currentUser.userId, historyTags);

        console.log('✅ 数据已保存到本地存储');
      } catch (error) {
        console.error('❌ 保存到本地存储失败:', error);
        // 直接保存到localStorage
        localStorage.setItem(`history_${currentUser.userId}`, JSON.stringify(history));
        localStorage.setItem(`cardSetHistoryTags_${currentUser.userId}`, JSON.stringify(historyTags));
        console.log('✅ 数据已保存到localStorage');
      }
    }

    // 数据迁移函数
    async function migrateDataToCloud() {
      if (!currentUser) return;

      try {
        await cloudDB.migrateFromLocalStorage(currentUser.userId);
        showToast('旧格式数据迁移完成', 'success');
      } catch (error) {
        console.error('数据迁移失败:', error);
        showToast('数据迁移失败，请稍后重试', 'error');
      }
    }

    // 退出登录
    function logout() {
      showConfirm('确定要退出登录吗？当前数据已保存。', () => {
        try {
          // 保存当前数据
          if (currentUser) {
            saveUserData();
          }

          // 清除用户信息
          localStorage.removeItem('currentUser');
          currentUser = null;

          // 清空界面数据
          allFactors = [];
          correctAnswers = {};
          history = [];
          historyTags = [];

          // 渲染空界面
          renderHistory();
          renderHistoryTags();

          // 显示授权界面
          showAuthInterface();

          showToast('已退出登录', 'info');
        } catch (error) {
          console.error('退出登录时出错:', error);
          showToast('退出登录失败，请重试', 'error');
        }
      });
    }

    // 洗牌函数
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Toast 消息函数
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;

      container.appendChild(toast);

      // 显示动画
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);

      // 自动隐藏
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // 确认对话框函数
    function showConfirm(message, onConfirm, onCancel) {
      const dialog = document.createElement('div');
      dialog.className = 'confirm-dialog';
      dialog.innerHTML = `
        <div class="dialog-content">
          <p>${message}</p>
          <div class="dialog-buttons">
            <button class="btn-cancel">取消</button>
            <button class="btn-confirm">确定</button>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      // 绑定事件
      dialog.querySelector('.btn-cancel').onclick = () => {
        document.body.removeChild(dialog);
        if (onCancel) onCancel();
      };

      dialog.querySelector('.btn-confirm').onclick = () => {
        document.body.removeChild(dialog);
        if (onConfirm) onConfirm();
      };
    }

    // 优化分组输入区的添加和删除
    document
      .getElementById("addGroup")
      .addEventListener("click", function () {
        const container = document.getElementById("groupContainer");
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-input";
        groupDiv.style.display = "flex";
        groupDiv.style.gap = "10px";
        groupDiv.style.alignItems = "flex-start";
        groupDiv.innerHTML = `
                <div style="flex:1;">
                    <input type="text" placeholder="分组名称" class="group-name" style="width:100%;margin-bottom:6px;" />
                    <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width:100%;height:60px;"></textarea>
                </div>
                <button class="remove-group" style="background:#95a5a6;">删除</button>
            `;
        groupDiv.querySelector(".remove-group").onclick = function () {
          groupDiv.remove();
        };
        container.appendChild(groupDiv);
      });
    // 默认分组的删除按钮
    document.querySelector(".remove-group").onclick = function () {
      this.parentElement.remove();
    };

    document
      .getElementById("generate")
      .addEventListener("click", function () {
        // 验证题目名称
        const titleInput = document.getElementById("cardSetTitle");
        const titleTip = document.getElementById("titleRequiredTip");
        if (!titleInput.value.trim()) {
          titleTip.style.display = "inline";
          titleInput.focus();
          showToast("请输入题目名称", "error");
          return;
        } else {
          titleTip.style.display = "none";
        }

        // 验证分组数量
        const groupNames = document.querySelectorAll(".group-name");
        const groupItems = document.querySelectorAll(".group-items");
        const validGroups = [];

        groupNames.forEach((nameInput, index) => {
          const groupName = nameInput.value.trim();
          if (!groupName) return;

          const items = groupItems[index].value
            .split(/[\n,]+/)
            .map((s) => s.trim())
            .filter((s) => s);

          if (items.length === 0) {
            showToast(`分组"${groupName}"至少需要1个条目`, "error");
            groupItems[index].focus();
            return;
          }

          validGroups.push({ name: groupName, items: items });
        });

        if (validGroups.length < 2) {
          showToast("至少需要2个分组", "error");
          return;
        }

        allFactors = [];
        correctAnswers = {};

        validGroups.forEach((group) => {
          group.items.forEach((item) => {
            allFactors.push({ text: item, group: group.name, correct: false });
          });
          correctAnswers[group.name] = group.items;
        });

        const cardSetTitle =
          titleInput.value.trim() || `卡组${history.length + 1}`;

        history.push({
          title: cardSetTitle,
          tags: [...currentTags], // 使用当前标签数组
          factors: JSON.parse(JSON.stringify(allFactors)),
          correctAnswers: JSON.parse(JSON.stringify(correctAnswers)),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        (async function () {
          await saveHistory();
          renderHistory();
        })();
        renderMatchingArea(allFactors, correctAnswers);
        // 显示复习区域
        document.getElementById("reviewSection").style.display = "block";

        // 清除所有输入框
        clearAllInputs();
        renderHistory(); // 再次刷新历史区
      });

    function renderHistory(filteredHistory = null) {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";

      // 确保 history 是数组
      if (!Array.isArray(history)) {
        history = [];
      }

      const displayHistory = filteredHistory || history;

      // 确保 displayHistory 是数组
      if (!Array.isArray(displayHistory)) {
        displayHistory = [];
      }

      if (displayHistory.length === 0) {
        const noResultDiv = document.createElement("div");
        noResultDiv.style.textAlign = "center";
        noResultDiv.style.color = "#666";
        noResultDiv.style.padding = "20px";
        noResultDiv.textContent = filteredHistory ? "没有找到匹配的卡组" : "暂无历史卡组";
        historyList.appendChild(noResultDiv);
        return;
      }

      displayHistory.forEach((entry, index) => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "history-card";
        cardDiv.style.cssText = `
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        `;

        cardDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h3 style="margin: 0; color: #2c3e50; font-size: 1.1em;">${entry.title || `卡组 ${index + 1}`}</h3>
            <div style="display: flex; gap: 5px;">
                      <button class="edit-card" style="background: #e67e22; padding: 4px 8px; font-size: 0.8em; border: none; color: white; border-radius: 4px; cursor: pointer;">编辑</button>
        <button class="delete-card" style="background: #95a5a6; padding: 4px 8px; font-size: 0.8em; border: none; color: white; border-radius: 4px; cursor: pointer;">删除</button>
            </div>
          </div>
          <div style="margin-bottom: 8px;">
            ${entry.tags && entry.tags.length > 0 ?
            `<div style="display: flex; flex-wrap: wrap; gap: 4px;">
                ${entry.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 12px; font-size: 0.8em;">${tag}</span>`).join('')}
              </div>` :
            '<span style="color: #999; font-size: 0.9em;">无标签</span>'
          }
          </div>
          <div style="color: #666; font-size: 0.9em;">
            创建时间: ${new Date(entry.createdAt).toLocaleString()}
          </div>
        `;

        // 点击卡片进入复习模式
        cardDiv.addEventListener("click", (e) => {
          if (!e.target.classList.contains('edit-card') && !e.target.classList.contains('delete-card')) {
            const originalIndex = history.indexOf(entry);
            showReviewModePopup((mode) => chooseHistoryMode(originalIndex, mode));
          }
        });

        // 编辑按钮
        cardDiv.querySelector('.edit-card').addEventListener("click", (e) => {
          e.stopPropagation();
          editCard(entry, history.indexOf(entry));
        });

        // 删除按钮
        cardDiv.querySelector('.delete-card').addEventListener("click", (e) => {
          e.stopPropagation();
          deleteCard(history.indexOf(entry));
        });

        historyList.appendChild(cardDiv);
      });
    }

    // 新增：弹窗选择复习模式
    function showReviewModePopup(callback) {
      reviewModeCallback = callback;
      document.getElementById("reviewModePopup").style.display = "flex";
    }
    document.getElementById("reviewAllBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
      if (reviewModeCallback) reviewModeCallback("all");
    };
    document.getElementById("reviewWrongBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
      if (reviewModeCallback) reviewModeCallback("wrong");
    };
    document.getElementById("cancelReviewBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
    };

    function chooseHistoryMode(index, mode) {
      const entry = history[index];
      if (mode === "all") {
        // 打乱factors顺序
        const shuffled = shuffleArray(entry.factors.slice());
        allFactors = shuffled;
        correctAnswers = entry.correctAnswers;
        renderMatchingArea(shuffled, entry.correctAnswers);
        // 显示复习区域
        document.getElementById("reviewSection").style.display = "block";
      } else if (mode === "wrong") {
        const wrongFactors = entry.factors.filter((f) => f.correct === false);
        const wrongAnswers = {};
        Object.keys(entry.correctAnswers).forEach((groupName) => {
          const filtered = entry.correctAnswers[groupName].filter((item) =>
            wrongFactors.find((f) => f.text === item)
          );
          if (filtered.length > 0) wrongAnswers[groupName] = filtered;
        });
        if (Object.keys(wrongAnswers).length === 0) {
          showToast("该卡组没有历史错题！", "warning");
          return;
        }
        allFactors = wrongFactors;
        correctAnswers = wrongAnswers;
        renderMatchingArea(wrongFactors, wrongAnswers);
        // 显示复习区域
        document.getElementById("reviewSection").style.display = "block";
      }
    }

    function renderMatchingArea(factors, answers) {
      const matchingArea = document.getElementById("matchingArea");
      matchingArea.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "grid";
      grid.id = "itemPool";

      factors.forEach((factor) => {
        const div = createDraggableItem(factor.text, factor.group);
        grid.appendChild(div);
      });

      matchingArea.appendChild(grid);

      const columns = document.createElement("div");
      columns.className = "columns";

      Object.keys(answers).forEach((groupName) => {
        const question = document.createElement("div");
        question.className = "question";
        question.innerHTML = `<strong>${groupName}：</strong>`;

        // dropzone wrapper
        const dropzoneWrapper = document.createElement("div");
        dropzoneWrapper.className = "dropzone-wrapper";

        // 主 dropzone
        const dropzone = document.createElement("div");
        dropzone.className = "dropzone";
        dropzone.dataset.group = groupName;

        enableDrop(dropzone);

        dropzoneWrapper.appendChild(dropzone);

        // 初次渲染时就分列
        splitDropzoneColumns(dropzone, dropzoneWrapper);

        // 结果区域
        const resultDiv = document.createElement("div");
        resultDiv.className = "result";
        resultDiv.id = "result-" + groupName;

        question.appendChild(dropzoneWrapper);
        question.appendChild(resultDiv);
        columns.appendChild(question);

        // --- 多栏分割 ---
        dropzone.addEventListener("DOMSubtreeModified", function () {
          splitDropzoneColumns(dropzone, dropzoneWrapper);
        });
      });

      matchingArea.appendChild(columns);

      document.getElementById("checkAnswers").style.display = "inline-block";
    }

    // 多栏分割逻辑
    function splitDropzoneColumns(dropzone, wrapper) {
      if (!dropzone || !wrapper) return;
      // 收集所有 item
      let items = [];
      wrapper.querySelectorAll(".dropzone, .dropzone-col").forEach((col) => {
        items = items.concat(Array.from(col.children));
      });
      // 清空 wrapper
      wrapper.innerHTML = "";

      // 计算栏数
      let colCount = 1;
      if (items.length > 3) colCount = 2;
      if (items.length > 6) colCount = 3;
      if (items.length > 12) colCount = 4;

      // 分配到多栏
      const columns = Array.from({ length: colCount }, () => []);
      items.forEach((item, idx) => {
        columns[idx % colCount].push(item);
      });

      // 创建新栏
      for (let i = 0; i < colCount; i++) {
        const colDiv = document.createElement("div");
        colDiv.className = i === 0 ? "dropzone" : "dropzone-col";
        colDiv.style.display = "flex";
        colDiv.style.flexDirection = "column";
        colDiv.style.flex = "1 1 0";
        colDiv.style.gap = "4px";
        colDiv.style.minWidth = "60px";
        columns[i].forEach((item) => colDiv.appendChild(item));
        // 只主栏可拖拽
        if (i === 0) enableDrop(colDiv);
        wrapper.appendChild(colDiv);
      }
    }

    function createDraggableItem(text, group) {
      const div = document.createElement("div");
      div.className = "item";
      div.draggable = true;
      div.textContent = text;
      div.dataset.group = group;

      div.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ text, group }));
      });

      return div;
    }

    function enableDrop(dropzone) {
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("over");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("over");
      });

      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("over");
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));

        removeItemFromAll(data.text);

        const itemDiv = createDraggableItem(data.text, data.group);
        dropzone.appendChild(itemDiv);
      });
    }

    document.addEventListener("dragend", function (e) {
      const itemPool = document.getElementById("itemPool");
      if (e.target.classList.contains("item")) {
        const rect = itemPool.getBoundingClientRect();
        if (
          e.pageX >= rect.left &&
          e.pageX <= rect.right &&
          e.pageY >= rect.top &&
          e.pageY <= rect.bottom
        ) {
          removeItemFromAll(e.target.textContent);
          itemPool.appendChild(e.target);
        }
      }
    });

    function removeItemFromAll(text) {
      document.querySelectorAll(".item").forEach((item) => {
        if (item.textContent === text) {
          item.remove();
        }
      });
    }

    document
      .getElementById("checkAnswers")
      .addEventListener("click", function () {
        // 重置所有item的颜色
        document.querySelectorAll(".item").forEach((item) => {
          item.classList.remove("correct", "incorrect");
        });

        // 隐藏"再来一遍"按钮
        document.getElementById("restartBtn").style.display = "none";

        Object.keys(correctAnswers).forEach((groupName) => {
          // 最简单的方法：直接查找所有在分类区域内的item
          const allItems = document.querySelectorAll('.item');
          let items = [];

          // 找到所有不在itemPool中的item（即已经拖入分类区域的item）
          allItems.forEach(item => {
            const parent = item.parentElement;
            // 检查item是否在分类区域内（不在itemPool中）
            if (parent && !parent.id.includes('itemPool')) {
              // 检查这个item是否在当前分类的区域内
              const questionDiv = parent.closest('.question');
              if (questionDiv) {
                const questionTitle = questionDiv.querySelector('strong');
                if (questionTitle && questionTitle.textContent.includes(groupName)) {
                  items.push(item);
                }
              }
            }
          });

          // 调试信息
          console.log(`[${groupName}] 找到 ${items.length} 个item:`, items.map(item => item.textContent));

          // 获取该分类的正确答案集合
          const correctSet = new Set(correctAnswers[groupName]);
          let correctCount = 0;
          let answeredCount = 0;

          items.forEach((item) => {
            answeredCount++;
            // 根据item原本所属的类别判断正确性
            const itemOriginalGroup = item.dataset.group;
            const isCorrect = itemOriginalGroup === groupName;



            if (isCorrect) {
              item.classList.add("correct");
              item.classList.remove("incorrect");
              correctCount++;
            } else {
              item.classList.add("incorrect");
              item.classList.remove("correct");
            }

            // 更新allFactors中的正确性状态
            allFactors.forEach((f) => {
              if (f.text === item.textContent) {
                f.correct = isCorrect;
              }
            });
          });

          const resultDiv = document.getElementById("result-" + groupName);
          if (answeredCount > 0) {
            resultDiv.textContent = `已作答：${answeredCount}个，正确：${correctCount}个 / 总计：${correctAnswers[groupName].length}个`;
          } else {
            resultDiv.textContent = `未作答 / 总计：${correctAnswers[groupName].length}个`;
          }
        });

        // 覆盖同步到历史卡组
        history.forEach((entry) => {
          entry.factors.forEach((f) => {
            const updated = allFactors.find((af) => af.text === f.text);
            if (updated) f.correct = updated.correct;
          });
        });
        (async function () {
          await saveHistory();
        })();

        // 新增：如果所有item都被拖入分类栏，则锁定所有分类栏内的item，并显示"再来一遍"按钮
        const itemPool = document.getElementById("itemPool");
        if (itemPool && itemPool.children.length === 0) {
          document.querySelectorAll('.question .item').forEach(item => {
            item.draggable = false;
            item.classList.add('locked');
          });
          // 显示"再来一遍"按钮
          document.getElementById("restartBtn").style.display = "inline-block";
        }
      });

    async function saveHistory() {
      if (currentUser) {
        try {
          await cloudDB.saveCardSets(currentUser.userId, history);
          console.log('历史卡组已保存到本地存储');
        } catch (error) {
          console.error('保存历史卡组失败，使用localStorage:', error);
          localStorage.setItem(`history_${currentUser.userId}`, JSON.stringify(history));
        }
      }
    }

    function backupHistory() {
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
      const key = "cardGroupHistory_backup_" + dateStr;
      localStorage.setItem(key, JSON.stringify(history));
    }

    // 启动时立即备份一次
    backupHistory();
    // 每24小时备份一次
    setInterval(backupHistory, 24 * 60 * 60 * 1000);

    // 编辑卡组功能
    function editCard(entry, index) {
      // 填充表单
      document.getElementById("cardSetTitle").value = entry.title || "";
      currentTags = entry.tags ? [...entry.tags] : [];
      renderTags();
      renderHistoryTags();

      // 清空现有分组
      const container = document.getElementById("groupContainer");
      container.innerHTML = "";

      // 重新创建分组
      Object.keys(entry.correctAnswers).forEach((groupName, groupIndex) => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-input";
        groupDiv.style.display = "flex";
        groupDiv.style.gap = "10px";
        groupDiv.style.alignItems = "flex-start";
        groupDiv.innerHTML = `
          <div style="flex:1;">
            <input type="text" placeholder="分组名称" class="group-name" style="width:100%;margin-bottom:6px;" value="${groupName}" />
            <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width:100%;height:60px;">${entry.correctAnswers[groupName].join(", ")}</textarea>
          </div>
          <button class="remove-group" style="background:#e57373;">删除</button>
        `;
        groupDiv.querySelector(".remove-group").onclick = function () {
          groupDiv.remove();
        };
        container.appendChild(groupDiv);
      });

      // 修改生成按钮行为为更新
      const generateBtn = document.getElementById("generate");
      generateBtn.textContent = "更新卡组";
      generateBtn.onclick = function () {
        updateCard(index);
      };

      // 滚动到顶部
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 更新卡组
    function updateCard(index) {
      // 验证题目名称
      const titleInput = document.getElementById("cardSetTitle");
      const titleTip = document.getElementById("titleRequiredTip");
      if (!titleInput.value.trim()) {
        titleTip.style.display = "inline";
        titleInput.focus();
        showToast("请输入题目名称", "error");
        return;
      } else {
        titleTip.style.display = "none";
      }

      // 验证分组数量
      const groupNames = document.querySelectorAll(".group-name");
      const groupItems = document.querySelectorAll(".group-items");
      const validGroups = [];

      groupNames.forEach((nameInput, groupIndex) => {
        const groupName = nameInput.value.trim();
        if (!groupName) return;

        const items = groupItems[groupIndex].value
          .split(/[\n,]+/)
          .map((s) => s.trim())
          .filter((s) => s);

        if (items.length === 0) {
          showToast(`分组"${groupName}"至少需要1个条目`, "error");
          groupItems[groupIndex].focus();
          return;
        }

        validGroups.push({ name: groupName, items: items });
      });

      if (validGroups.length < 2) {
        showToast("至少需要2个分组", "error");
        return;
      }

      const newFactors = [];
      const newCorrectAnswers = {};

      validGroups.forEach((group) => {
        group.items.forEach((item) => {
          newFactors.push({ text: item, group: group.name, correct: false });
        });
        newCorrectAnswers[group.name] = group.items;
      });

      const cardSetTitle = titleInput.value.trim();

      // 更新历史记录
      history[index] = {
        title: cardSetTitle,
        tags: [...currentTags],
        factors: JSON.parse(JSON.stringify(newFactors)),
        correctAnswers: JSON.parse(JSON.stringify(newCorrectAnswers)),
        createdAt: history[index].createdAt,
        updatedAt: new Date().toISOString()
      };

      (async function () {
        await saveHistory();
        renderHistory();
      })();

      // 重置表单和按钮
      resetForm();

      showToast("卡组更新成功！", "success");
    }

    // 删除卡组
    function deleteCard(index) {
      showConfirm("确定要删除这个卡组吗？此操作不可撤销。", () => {
        // 检查是否正在复习被删除的卡组
        const deletedCard = history[index];
        const isCurrentlyReviewing = allFactors.length > 0 &&
          allFactors.some(factor =>
            deletedCard.factors.some(f => f.text === factor.text)
          );

        // 删除卡组
        history.splice(index, 1);
        (async function () {
          await saveHistory();
          renderHistory();
        })();

        // 如果正在复习被删除的卡组，清除复习数据
        if (isCurrentlyReviewing) {
          clearReviewData();
          showToast("卡组已删除！正在复习的数据已清除。", "success");
        } else {
          showToast("卡组已删除！", "success");
        }
      });
    }

    // 清除复习数据
    function clearReviewData() {
      allFactors = [];
      correctAnswers = {};
      document.getElementById("matchingArea").innerHTML = "";
      document.getElementById("checkAnswers").style.display = "none";
      document.getElementById("restartBtn").style.display = "none";
      // 隐藏复习区域
      document.getElementById("reviewSection").style.display = "none";
    }

    // 标签管理
    // 加载历史标签池
    async function loadHistoryTags() {
      if (!currentUser) return;
      try {
        historyTags = await cloudDB.getHistoryTags(currentUser.userId);
        console.log('历史标签已从本地存储加载');
      } catch (error) {
        console.error('从本地存储加载历史标签失败，使用旧格式:', error);
        const saved = localStorage.getItem(`cardSetHistoryTags_${currentUser.userId}`);
        if (saved) {
          historyTags = JSON.parse(saved);
        } else {
          historyTags = [];
        }
      }
    }
    // 保存历史标签池
    async function saveHistoryTags() {
      if (!currentUser) return;
      try {
        await cloudDB.saveHistoryTags(currentUser.userId, historyTags);
        console.log('历史标签已保存到本地存储');
      } catch (error) {
        console.error('保存历史标签失败，使用localStorage:', error);
        localStorage.setItem(`cardSetHistoryTags_${currentUser.userId}`, JSON.stringify(historyTags));
      }
    }
    // 添加到历史标签池
    function addToHistoryTags(tag) {
      if (!historyTags.includes(tag)) {
        historyTags.unshift(tag);
        // 最多保存40个
        if (historyTags.length > 40) historyTags = historyTags.slice(0, 40);
        (async function () {
          await saveHistoryTags();
        })();
      } else {
        // 移到最前
        historyTags = [tag, ...historyTags.filter(t => t !== tag)];
        (async function () {
          await saveHistoryTags();
        })();
      }
    }

    // 添加标签
    function addTag(tagText) {
      const trimmedTag = tagText.trim();
      if (trimmedTag && !currentTags.includes(trimmedTag)) {
        currentTags.unshift(trimmedTag); // 最新在前
        addToHistoryTags(trimmedTag);
        renderTags();
        renderHistoryTags();
        document.getElementById("cardSetTags").value = "";
      }
    }
    // 删除标签
    function removeTag(tagText) {
      currentTags = currentTags.filter(tag => tag !== tagText);
      renderTags();
      renderHistoryTags();
    }
    // 渲染标签
    function renderTags() {
      const container = document.getElementById("tagsContainer");
      container.innerHTML = "";
      const maxTags = 16;
      const displayTags = currentTags.slice(0, maxTags);
      displayTags.forEach(tag => {
        const tagElement = document.createElement("div");
        tagElement.className = "tag";
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button class="remove-tag" onclick="removeTag('${tag}')" title="删除标签">×</button>
        `;
        container.appendChild(tagElement);
      });
      if (currentTags.length > maxTags) {
        const moreElement = document.createElement("div");
        moreElement.className = "tag";
        moreElement.style.background = "#f5f5f5";
        moreElement.style.color = "#666";
        moreElement.style.cursor = "default";
        moreElement.innerHTML = `<span>+${currentTags.length - maxTags}个</span>`;
        container.appendChild(moreElement);
      }
    }
    // 删除历史标签
    function removeHistoryTag(tagText) {
      historyTags = historyTags.filter(tag => tag !== tagText);
      (async function () {
        await saveHistoryTags();
      })();
      renderHistoryTags();
      showToast(`已删除历史标签"${tagText}"`, "success");
    }

    // 渲染历史标签区
    function renderHistoryTags() {
      const container = document.getElementById("historyTagsContainer");
      container.innerHTML = "";

      // 确保 currentTags 是数组
      if (!Array.isArray(currentTags)) {
        currentTags = [];
      }

      // 只显示未选中的历史标签，最新在前，最多2行16个
      const displayTags = historyTags.filter(tag => !currentTags.includes(tag)).slice(0, 16);
      displayTags.forEach(tag => {
        const tagElement = document.createElement("div");
        tagElement.className = "tag selectable";
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button class="remove-tag" onclick="removeHistoryTag('${tag}')" title="删除历史标签">×</button>
        `;
        tagElement.onclick = function (e) {
          // 如果点击的是删除按钮，不触发选择
          if (e.target.classList.contains('remove-tag')) {
            return;
          }
          addTag(tag);
        };
        container.appendChild(tagElement);
      });
      if (historyTags.filter(tag => !currentTags.includes(tag)).length > 16) {
        const moreElement = document.createElement("div");
        moreElement.className = "tag selectable";
        moreElement.style.background = "#f5f5f5";
        moreElement.style.color = "#666";
        moreElement.style.cursor = "default";
        moreElement.innerHTML = `<span>+${historyTags.length - 16}个</span>`;
        container.appendChild(moreElement);
      }
    }

    // 搜索功能
    document.getElementById("searchBtn").addEventListener("click", function () {
      const searchTerm = document.getElementById("searchTags").value.trim().toLowerCase();
      if (!searchTerm) {
        renderHistory();
        return;
      }

      const filteredHistory = history.filter(entry => {
        // 搜索标题
        if (entry.title && entry.title.toLowerCase().includes(searchTerm)) {
          return true;
        }
        // 搜索标签
        if (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchTerm))) {
          return true;
        }
        return false;
      });

      renderHistory(filteredHistory);
    });

    // 清除搜索
    document.getElementById("clearSearchBtn").addEventListener("click", function () {
      document.getElementById("searchTags").value = "";
      renderHistory();
    });

    // 标签输入事件
    document.getElementById("cardSetTags").addEventListener("keydown", function (e) {
      if (e.key === "Enter" || e.key === ",") {
        e.preventDefault();
        const value = this.value;
        if (e.key === ",") {
          const parts = value.split(",");
          if (parts.length > 1) {
            addTag(parts[0]);
            this.value = parts.slice(1).join(",");
          }
        } else {
          addTag(value);
        }
      }
    });
    document.getElementById("cardSetTags").addEventListener("blur", function () {
      if (this.value.trim()) {
        addTag(this.value);
      }
    });

    // 新建卡组按钮
    document.getElementById("newCard").addEventListener("click", function () {
      resetForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // 再来一遍按钮
    document.getElementById("restartBtn").addEventListener("click", function () {
      showReviewModePopup((mode) => {
        if (mode === "all") {
          // 全部打乱复习
          const shuffled = shuffleArray(allFactors.slice());
          renderMatchingArea(shuffled, correctAnswers);
          // 显示复习区域
          document.getElementById("reviewSection").style.display = "block";
          // 隐藏"再来一遍"按钮
          document.getElementById("restartBtn").style.display = "none";
        } else if (mode === "wrong") {
          // 只复习错题
          const wrongFactors = allFactors.filter((f) => f.correct === false);
          const wrongAnswers = {};
          Object.keys(correctAnswers).forEach((groupName) => {
            const filtered = correctAnswers[groupName].filter((item) =>
              wrongFactors.find((f) => f.text === item)
            );
            if (filtered.length > 0) wrongAnswers[groupName] = filtered;
          });
          if (Object.keys(wrongAnswers).length === 0) {
            showToast("没有错题需要复习！", "warning");
            return;
          }
          renderMatchingArea(wrongFactors, wrongAnswers);
          // 显示复习区域
          document.getElementById("reviewSection").style.display = "block";
          // 隐藏"再来一遍"按钮
          document.getElementById("restartBtn").style.display = "none";
        }
      });
    });

    // 清除所有输入框
    function clearAllInputs() {
      document.getElementById("cardSetTitle").value = "";
      document.getElementById("cardSetTags").value = "";
      currentTags = [];
      renderTags();
      renderHistoryTags();
      document.getElementById("groupContainer").innerHTML = `
        <div class="group-input">
          <div style="flex: 1">
            <input type="text" placeholder="分组名称 (如：促进胃酸分泌的因素)" class="group-name"
              style="width: 100%; margin-bottom: 6px" />
            <textarea placeholder="条目列表 (用逗号或换行分隔)" class="group-items" style="width: 100%; height: 60px"></textarea>
          </div>
          <button class="remove-group" style="background: #95a5a6">删除</button>
        </div>
      `;

      // 重新绑定删除按钮
      document.querySelector(".remove-group").onclick = function () {
        this.parentElement.remove();
      };
    }

    // 重置表单
    function resetForm() {
      clearAllInputs();

      // 重新绑定删除按钮
      document.querySelector(".remove-group").onclick = function () {
        this.parentElement.remove();
      };

      // 重置生成按钮
      const generateBtn = document.getElementById("generate");
      generateBtn.textContent = "生成配对题";
      generateBtn.onclick = function () {
        // 恢复原来的生成逻辑
        // 验证题目名称
        const titleInput = document.getElementById("cardSetTitle");
        const titleTip = document.getElementById("titleRequiredTip");
        if (!titleInput.value.trim()) {
          titleTip.style.display = "inline";
          titleInput.focus();
          showToast("请输入题目名称", "error");
          return;
        } else {
          titleTip.style.display = "none";
        }

        // 验证分组数量
        const groupNames = document.querySelectorAll(".group-name");
        const groupItems = document.querySelectorAll(".group-items");
        const validGroups = [];

        groupNames.forEach((nameInput, index) => {
          const groupName = nameInput.value.trim();
          if (!groupName) return;

          const items = groupItems[index].value
            .split(/[\n,]+/)
            .map((s) => s.trim())
            .filter((s) => s);

          if (items.length === 0) {
            showToast(`分组"${groupName}"至少需要1个条目`, "error");
            groupItems[index].focus();
            return;
          }

          validGroups.push({ name: groupName, items: items });
        });

        if (validGroups.length < 2) {
          showToast("至少需要2个分组", "error");
          return;
        }

        allFactors = [];
        correctAnswers = {};

        validGroups.forEach((group) => {
          group.items.forEach((item) => {
            allFactors.push({ text: item, group: group.name, correct: false });
          });
          correctAnswers[group.name] = group.items;
        });

        const cardSetTitle =
          titleInput.value.trim() || `卡组${history.length + 1}`;

        history.push({
          title: cardSetTitle,
          tags: [...currentTags],
          factors: JSON.parse(JSON.stringify(allFactors)),
          correctAnswers: JSON.parse(JSON.stringify(correctAnswers)),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        (async function () {
          await saveHistory();
          renderHistory();
        })();
        renderMatchingArea(allFactors, correctAnswers);
      };
    }

    // 授权验证事件监听器
    document.getElementById('authSubmitBtn').addEventListener('click', async function () {
      const authCode = document.getElementById('authCodeInput').value.trim();
      if (!authCode) {
        showToast('请输入授权码', 'error');
        return;
      }

      try {
        const success = await validateAuthCode(authCode);
        if (success) {
          document.getElementById('authCodeInput').value = '';
        } else {
          showToast('授权码验证失败', 'error');
        }
      } catch (error) {
        console.error('授权验证失败:', error);
        showToast('授权验证失败，请稍后重试', 'error');
      }
    });

    // 授权码输入框回车事件
    document.getElementById('authCodeInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        document.getElementById('authSubmitBtn').click();
      }
    });

    // 退出登录按钮事件
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // 授权码管理按钮事件
    document.getElementById('licenseBtn').addEventListener('click', function() {
      // 打开授权码管理页面
      window.open('src/pages/license-manager.html', '_blank');
    });

    // 帮助按钮和tooltip逻辑
    document.addEventListener('DOMContentLoaded', function () {
      const helpBtn = document.getElementById('helpBtn');
      const helpTooltip = document.getElementById('helpTooltip');
      const closeHelpTooltip = document.getElementById('closeHelpTooltip');
      if (helpBtn && helpTooltip && closeHelpTooltip) {
        helpBtn.addEventListener('click', function (e) {
          helpTooltip.style.display = 'block';
        });
        closeHelpTooltip.addEventListener('click', function () {
          helpTooltip.style.display = 'none';
        });
        // 点击tooltip外部关闭
        document.addEventListener('mousedown', function (event) {
          if (helpTooltip.style.display === 'block' && !helpTooltip.contains(event.target) && event.target !== helpBtn) {
            helpTooltip.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>

</html>