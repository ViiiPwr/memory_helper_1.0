<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>å­¦æˆé€‰æ‹©é¢˜â€”â€”é…å¯¹å¡ç‰‡ç»ƒä¹ </title>

  <!-- æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨ -->
  <script src="src/js/local-storage.js"></script>
  <!-- æˆæƒç ç®¡ç†å™¨ V2 -->
  <script src="src/js/license-manager-v2.js"></script>

  <!-- äº‘æ‰˜ç®¡ç¯å¢ƒä¸‹çš„äº‘å¼€å‘åˆå§‹åŒ– -->
  <script>
    // å…¨å±€å˜é‡å£°æ˜
    let allFactors = [];
    let correctAnswers = {};
    let history = [];
    let currentTags = [];
    let historyTags = [];
    let currentUser = null;
    let reviewModeCallback = null;

    // æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨æ£€æµ‹
    console.log('=== æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨æ£€æµ‹ ===');
    console.log('LocalStorageManager:', typeof LocalStorageManager !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');

    // æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨åˆå§‹åŒ–
    // æ³¨æ„ï¼šlocalStorageManagerå·²åœ¨local-storage.jsä¸­åˆ›å»º

    // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
    async function initLocalStorage() {
      try {
        if (typeof localStorageManager !== 'undefined') {
          console.log('âœ… æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨å·²å¯ç”¨');
          return true;
        } else {
          console.warn('æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨æœªåŠ è½½ï¼Œä½¿ç”¨åŸºç¡€localStorage');
          return false;
        }
      } catch (error) {
        console.error('âŒ æœ¬åœ°å­˜å‚¨åˆå§‹åŒ–å¤±è´¥:', error);
        return false;
      }
    }

    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ˜¯å¦å¯ç”¨
    async function isLocalStorageAvailable() {
      try {
        const testKey = 'test_storage';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch (error) {
        console.error('æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨:', error);
        return false;
      }
    }

    // å…¼å®¹æ€§åŒ…è£…å™¨ - ä¿æŒåŸæœ‰çš„cloudDBæ¥å£
    if (typeof cloudDB === 'undefined') {
      window.cloudDB = {
        isAvailable: () => true,
        saveUser: async (userData) => {
          return await localStorageManager.saveUser(userData);
        },
        getUser: async (userId) => {
          return await localStorageManager.getUser(userId);
        },
        saveCardSets: async (userId, cardSets) => {
          return await localStorageManager.saveCardSets(userId, cardSets);
        },
        getCardSets: async (userId) => {
          return await localStorageManager.getCardSets(userId);
        },
        saveHistoryTags: async (userId, tags) => {
          return await localStorageManager.saveHistoryTags(userId, tags);
        },
        getHistoryTags: async (userId) => {
          return await localStorageManager.getHistoryTags(userId);
        },
        migrateFromLocalStorage: async (userId) => {
          return await localStorageManager.migrateFromLegacyFormat(userId);
        }
      };
    }

    // å…¨å±€æµ‹è¯•å‡½æ•°
    window.testLocalStorage = async function () {
      console.log('=== æœ¬åœ°å­˜å‚¨æµ‹è¯• ===');

      // 1. æ£€æŸ¥æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨
      console.log('1. æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨æ£€æŸ¥:');
      console.log('  LocalStorageManager:', typeof LocalStorageManager !== 'undefined' ? 'âœ…' : 'âŒ');
      console.log('  localStorageManager:', typeof localStorageManager !== 'undefined' ? 'âœ…' : 'âŒ');

      // 2. æ£€æŸ¥å…¼å®¹æ€§æ¥å£
      console.log('2. å…¼å®¹æ€§æ¥å£æ£€æŸ¥:');
      console.log('  cloudDB (å…¼å®¹æ€§):', typeof cloudDB !== 'undefined' ? 'âœ…' : 'âŒ');

      // 3. æµ‹è¯•æœ¬åœ°å­˜å‚¨å¯ç”¨æ€§
      console.log('3. æœ¬åœ°å­˜å‚¨å¯ç”¨æ€§æµ‹è¯•:');
      try {
        const isAvailable = await isLocalStorageAvailable();
        console.log('  âœ… æœ¬åœ°å­˜å‚¨å¯ç”¨:', isAvailable);
      } catch (error) {
        console.log('  âŒ æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨:', error.message);
      }

      // 4. æµ‹è¯•å­˜å‚¨ä¿¡æ¯
      if (typeof localStorageManager !== 'undefined') {
        console.log('4. å­˜å‚¨ä¿¡æ¯:');
        try {
          const storageInfo = localStorageManager.getStorageInfo();
          console.log('  æ€»å¤§å°:', storageInfo.totalSizeFormatted);
          console.log('  é¡¹ç›®æ•°é‡:', storageInfo.itemCount);
          console.log('  å­˜å‚¨é¡¹ç›®:', storageInfo.items);
        } catch (error) {
          console.log('  âŒ è·å–å­˜å‚¨ä¿¡æ¯å¤±è´¥:', error.message);
        }
      }

      console.log('=== æµ‹è¯•å®Œæˆ ===');
    };
  </script>
  <style>
    body {
      font-family: "Segoe UI", "PingFang SC", "Hiragino Sans", Arial,
        sans-serif;
      padding: 2vw;
      background: #f8f9fa;
      color: #333;
      margin: 0;
    }

    h1,
    h2 {
      color: #2c3e50;
    }

    h1 {
      text-align: center;
    }

    input,
    textarea,
    button {
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #bbb;
      padding: 8px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    input:focus,
    textarea:focus {
      outline: 2px solid #3498db;
    }

    button {
      background: #3498db;
      color: #fff;
      border: none;
      margin-right: 10px;
      transition: background 0.2s;
    }

    button:hover {
      background: #2980b9;
    }

    .group-input {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .item {
      border: 1px solid #ddd;
      padding: 10px 16px;
      background: #ecf0f1;
      cursor: grab;
      user-select: none;
      border-radius: 6px;
      min-width: 80px;
      text-align: center;
      font-weight: 500;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .item.locked {
      cursor: not-allowed !important;
      opacity: 0.7;
    }

    /* Toast æ¶ˆæ¯æ ·å¼ */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      pointer-events: none;
    }

    /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .confirm-dialog .dialog-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
    }

    .confirm-dialog .dialog-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    .confirm-dialog button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .confirm-dialog .btn-cancel {
      background: #9e9e9e;
      color: white;
    }

    .confirm-dialog .btn-confirm {
      background: #f44336;
      color: white;
    }

    /* åŒºåŸŸåˆ†éš”æ ·å¼ */
    .section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      color: #2c3e50;
      font-size: 1.4em;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #ecf0f1;
      display: flex;
      align-items: center;
    }

    .section-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: #3498db;
      margin-right: 12px;
      border-radius: 2px;
    }

    .section-content {
      margin-top: 16px;
    }

    /* æ ‡ç­¾æ ·å¼ */
    .tag {
      background: #ecf0f1;
      color: #2c3e50;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid #bdc3c7;
      transition: all 0.2s;
    }

    .tag:hover {
      background: #d5dbdb;
      transform: translateY(-1px);
    }

    .tag .remove-tag {
      background: none;
      border: none;
      color: #2c3e50;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
      margin: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .tag .remove-tag:hover {
      background: #2c3e50;
      color: white;
    }

    /* å†å²æ ‡ç­¾åˆ é™¤æŒ‰é’®æ ·å¼ */
    .tag.selectable .remove-tag {
      color: #7f8c8d;
      opacity: 0.7;
    }

    .tag.selectable .remove-tag:hover {
      background: #e74c3c;
      color: white;
      opacity: 1;
    }

    /* å¯é€‰æ ‡ç­¾åŒºæ ·å¼ */
    .tag.selectable {
      background: #f8f9fa;
      color: #2c3e50;
      border: 1px dashed #bdc3c7;
      cursor: pointer;
      opacity: 0.85;
    }

    .tag.selectable.selected {
      background: #3498db;
      color: #fff;
      border: 1px solid #3498db;
      opacity: 1;
    }

    .toast {
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      pointer-events: auto;
      max-width: 300px;
      word-wrap: break-word;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #f44336;
    }

    .toast.warning {
      background: #ff9800;
    }

    .dropzone,
    .dropzone-col {
      border: 2px dashed #bdc3c7;
      min-height: 50px;
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 10px;
      min-width: 120px;
      transition: background 0.2s;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1 1 0;
    }

    .dropzone-col {
      border: none !important;
      background: none !important;
      min-height: 0 !important;
      padding: 0 !important;
      margin-bottom: 0 !important;
    }

    .dropzone.over {
      background: #e8f4fd;
    }

    .dropzone-wrapper {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .columns {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .question {
      flex: 1 1 220px;
      min-width: 220px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      margin-bottom: 10px;
    }

    .result {
      margin-top: 5px;
      font-weight: bold;
      color: #27ae60;
    }

    #history {
      margin-top: 30px;
    }

    .history-item {
      margin-bottom: 10px;
      cursor: pointer;
      color: #3498db;
      text-decoration: underline;
      font-size: 1.1em;
    }

    .history-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .history-card .edit-card:hover {
      background: #d35400 !important;
    }

    .history-card .delete-card:hover {
      background: #7f8c8d !important;
    }

    /* ç¡®ä¿æ£€æŸ¥ç­”æ¡ˆæ—¶çš„é¢œè‰²ä¸è¢«è¦†ç›– */
    .item.correct {
      background-color: #27ae60 !important;
      border-color: #27ae60 !important;
    }

    .item.incorrect {
      background-color: #e74c3c !important;
      border-color: #e74c3c !important;
    }

    .main-title-bg {
      background: linear-gradient(90deg, #e3f0fc 0%, #d2f6e9 100%);
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(52, 152, 219, 0.08);
      padding: 28px 0 18px 0;
      margin: 0 auto 32px auto;
      max-width: 700px;
      text-align: center;
    }

    .main-title-bg h1 {
      margin: 0;
      font-size: 2.2rem;
      color: #2176ae;
      letter-spacing: 2px;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(52, 152, 219, 0.08);
    }

    .text-btn {
      background: none;
      border: none;
      color: #3498db;
      font-size: 15px;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .text-btn:hover {
      background: #e3f0fc;
    }

    .help-tooltip {
      position: absolute;
      top: 56px;
      right: 32px;
      z-index: 2000;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 24px #0002;
      padding: 0;
      min-width: 260px;
      max-width: 320px;
      border: 1px solid #e3f0fc;
      animation: fadeIn 0.2s;
    }

    .help-tooltip-content {
      padding: 18px 20px 12px 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 600px) {
      .columns {
        flex-direction: column;
        gap: 10px;
      }

      .question {
        min-width: unset;
      }

      .grid {
        flex-direction: column;
        gap: 6px;
      }

      .dropzone-wrapper {
        flex-direction: column !important;
        gap: 4px !important;
      }
    }
  </style>
</head>

<body>
  <!-- æˆæƒéªŒè¯ç•Œé¢ -->
  <div id="authOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  ">
    <div style="
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    ">
      <h2 style="color: #2c3e50; margin-bottom: 20px;">æ¬¢è¿ä½¿ç”¨é…å¯¹é¢˜ç”Ÿæˆå™¨</h2>
      <p style="color: #666; margin-bottom: 20px;">è¯·è¾“å…¥æˆæƒç ä»¥ç»§ç»­ä½¿ç”¨</p>
      <input type="text" id="authCodeInput" placeholder="è¯·è¾“å…¥æˆæƒç " style="
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        margin-bottom: 20px;
        box-sizing: border-box;
      ">
      <button id="authSubmitBtn" style="
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
      ">éªŒè¯æˆæƒç </button>
    </div>
  </div>

  <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
  <div id="userInfoBar" style="
    display: none;
    background: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  ">
    <div>
      <span style="color: #2c3e50; font-weight: 500;">ç”¨æˆ·ID: </span>
      <span id="currentUserId" style="color: #3498db;"></span>
    </div>
    <div style="display: flex; align-items: center; gap: 12px;">
      <button id="helpBtn" class="text-btn" type="button">ä½¿ç”¨æ•™ç¨‹</button>
      <button id="logoutBtn" style="
        background: #95a5a6;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      ">é€€å‡ºç™»å½•</button>
    </div>
    <div id="helpTooltip" class="help-tooltip" style="display:none;">
      <div class="help-tooltip-content">
        <div style="font-weight:bold; margin-bottom:6px;">ä½¿ç”¨æ•™ç¨‹</div>
        <div style="text-align:left; font-size:14px; line-height:1.7;">
          1. è¾“å…¥æˆæƒç ç™»å½•ï¼Œæ•°æ®è‡ªåŠ¨éš”ç¦»ã€‚<br>
          2. åˆ›å»ºæ–°å¡ç»„ï¼Œå¡«å†™é¢˜ç›®åç§°ã€æ ‡ç­¾ã€åˆ†ç»„å’Œæ¡ç›®ã€‚<br>
          3. ç”Ÿæˆé…å¯¹é¢˜åå¯åœ¨å†å²å¡ç»„ä¸­æŸ¥æ‰¾ã€ç¼–è¾‘ã€åˆ é™¤ã€‚<br>
          4. ç‚¹å‡»å†å²å¡ç»„å¯è¿›å…¥å¤ä¹ æ¨¡å¼ï¼Œæ”¯æŒå¤šæ¬¡æ£€æŸ¥ç­”æ¡ˆã€‚<br>
          5. æ ‡ç­¾å¯å¤šé€‰ï¼Œæ”¯æŒå¸¸ç”¨æ ‡ç­¾å¿«æ·é€‰æ‹©ã€‚<br>
          6. é€€å‡ºç™»å½•åï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚<br>
          7. å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿åé¦ˆï¼
        </div>
        <button id="closeHelpTooltip" class="text-btn" style="margin-top:10px;">å…³é—­</button>
      </div>
    </div>
  </div>

  <div class="main-title-bg">
    <h1>å­¦æˆé€‰æ‹©é¢˜â€”â€”é…å¯¹å¡ç‰‡ç»ƒä¹ </h1>
  </div>

  <!-- æ·»åŠ å¡ç»„åŒºåŸŸ -->
  <div class="section">
    <div class="section-title">åˆ›å»ºæ–°å¡ç»„</div>
    <div class="section-content">
      <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center">
        <label style="width: 80px; text-align: right; margin-right: 8px; white-space: nowrap;">é¢˜ç›®åç§°ï¼š</label>
        <input type="text" id="cardSetTitle" required placeholder="è¯·è¾“å…¥æœ¬å¡ç»„çš„é¢˜ç›®åç§°" style="width: 300px; padding: 6px" />
        <span id="titleRequiredTip" style="color: #e74c3c; margin-left: 8px; display: none">*å¿…å¡«</span>
      </div>
      <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center">
        <label style="width: 80px; text-align: right; margin-right: 8px; white-space: nowrap;">æ ‡ç­¾ï¼š</label>
        <input type="text" id="cardSetTags" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æˆ–é€—å·æ·»åŠ " style="width: 300px; padding: 6px" />
      </div>
      <div id="tagsDisplay" style="margin-bottom: 8px; display: flex; justify-content: center;">
        <div id="tagsContainer"
          style="display: flex; flex-wrap: wrap; gap: 6px; max-width: 60%; max-height: 80px; overflow: hidden;"></div>
      </div>
      <!-- å¯é€‰å†å²æ ‡ç­¾åŒº -->
      <div id="historyTagsDisplay" style="margin-bottom: 15px; display: flex; justify-content: center;">
        <div id="historyTagsContainer"
          style="display: flex; flex-wrap: wrap; gap: 6px; max-width: 60%; max-height: 80px; overflow: hidden;"></div>
      </div>
      <div id="groupContainer">
        <div class="group-input">
          <div style="flex: 1">
            <input type="text" placeholder="åˆ†ç»„åç§° (å¦‚ï¼šä¿ƒè¿›èƒƒé…¸åˆ†æ³Œçš„å› ç´ )" class="group-name"
              style="width: 100%; margin-bottom: 6px" />
            <textarea placeholder="æ¡ç›®åˆ—è¡¨ (ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”)" class="group-items" style="width: 100%; height: 60px"></textarea>
          </div>
          <button class="remove-group" style="background: #95a5a6">åˆ é™¤</button>
        </div>
      </div>
      <div style="
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
          ">
        <button id="addGroup" style="background: #e67e22;">æ·»åŠ æ–°åˆ†ç»„</button>
        <button id="generate">ç”Ÿæˆé…å¯¹é¢˜</button>
        <button id="newCard" style="background: #95a5a6;" title="æ¸…ç©ºæ‰€æœ‰è¾“å…¥ï¼Œå‡†å¤‡æ–°å»ºå¡ç»„">æ¸…ç©º</button>
      </div>
    </div>
  </div>

  <!-- Popup for review mode selection -->
  <div id="reviewModePopup" style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      ">
    <div style="
          background: #fff;
          padding: 32px 24px;
          border-radius: 12px;
          box-shadow: 0 4px 24px #0002;
          min-width: 240px;
          text-align: center;
        ">
      <div style="font-size: 1.1em; margin-bottom: 18px">è¯·é€‰æ‹©å¤ä¹ æ¨¡å¼</div>
      <button id="reviewAllBtn" style="margin-bottom: 10px; width: 80%">
        å…¨éƒ¨æ‰“ä¹±å¤ä¹ </button><br />
      <button id="reviewWrongBtn" style="background: #e67e22; width: 80%">
        åªå¤ä¹ é”™é¢˜</button><br />
      <button id="cancelReviewBtn" style="margin-top: 10px; background: #95a5a6; width: 80%">
        å–æ¶ˆ
      </button>
    </div>
  </div>

  <!-- å¤ä¹ åŒºåŸŸ -->
  <div class="section" id="reviewSection" style="display: none;">
    <div class="section-title">é…å¯¹ç»ƒä¹ </div>
    <div class="section-content">
      <div id="matchingArea"></div>
      <div style="display: flex; justify-content: center; margin-top: 10px">
        <button id="checkAnswers" style="display: none">æ£€æŸ¥ç­”æ¡ˆ</button>
        <button id="restartBtn" style="display: none; margin-left: 10px;">å†æ¥ä¸€é</button>
      </div>
    </div>
  </div>

  <!-- Toast æ¶ˆæ¯å®¹å™¨ -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- å†å²å¡ç»„åŒºåŸŸ -->
  <div class="section" id="history">
    <div class="section-title">å†å²å¡ç»„</div>
    <div class="section-content">
      <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="searchTags" placeholder="è¾“å…¥æ ‡ç­¾æœç´¢å¡ç»„" style="flex: 1; min-width: 200px; padding: 8px;" />
        <button id="searchBtn">æœç´¢</button>
        <button id="clearSearchBtn" style="background: #95a5a6;">æ¸…é™¤æœç´¢</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
  <div class="section" id="dataManagement">
    <div class="section-title">æ•°æ®ç®¡ç†</div>
    <div class="section-content">
      <div style="display: flex; gap: 10px; align-items: center;">
        <button id="exportDataBtn" style="background: #27ae60;">å¯¼å‡ºæ•°æ®</button>
        <button id="importDataBtn" style="background: #3498db;">å¯¼å…¥æ•°æ®</button>
      </div>
      <div id="dataManagementResult" style="margin-top: 10px;"></div>
    </div>
  </div>

  <script>
    // ç”¨æˆ·æ•°æ®ç®¡ç†
    // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
    async function initUserSystem() {
      // åˆå§‹åŒ–æˆæƒç ç³»ç»Ÿ
      console.log('æˆæƒç ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainInterface();
        await initUserData(); // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
      } else {
        showAuthInterface();
      }
    }

    initUserSystem();
    // å¯åŠ¨æ—¶åŠ è½½å†å²æ ‡ç­¾æ± 
    (async function () {
      await loadHistoryTags();
      renderHistoryTags();
    })();

    // æ˜¾ç¤ºæˆæƒç•Œé¢
    function showAuthInterface() {
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('userInfoBar').style.display = 'none';
      document.querySelector('h1').style.display = 'none';
      document.querySelector('.section').style.display = 'none';
    }

    // æ˜¾ç¤ºä¸»ç•Œé¢
    function showMainInterface() {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('userInfoBar').style.display = 'flex';
      document.querySelector('h1').style.display = 'block';
      document.querySelector('.section').style.display = 'block';
      document.getElementById('currentUserId').textContent = currentUser.userId;

      // æ¸…ç†ä¹‹å‰çš„ç®¡ç†å‘˜æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const existingLicenseBtn = document.getElementById('licenseBtn');
      if (existingLicenseBtn) {
        existingLicenseBtn.remove();
      }

      // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†æŒ‰é’®
      if (currentUser.isAdmin) {
        const adminBtn = document.createElement('button');
        adminBtn.id = 'licenseBtn';
        adminBtn.className = 'text-btn';
        adminBtn.style.color = '#e74c3c';
        adminBtn.textContent = 'ğŸ”‘ æˆæƒç ç®¡ç†';
        adminBtn.addEventListener('click', function () {
          window.open('src/pages/license-manager-v2.html', '_blank');
        });

        // æ’å…¥åˆ°å¸®åŠ©æŒ‰é’®åé¢
        const helpBtn = document.getElementById('helpBtn');
        helpBtn.parentNode.insertBefore(adminBtn, helpBtn.nextSibling);
      }
    }

    // éªŒè¯æˆæƒç ï¼ˆé›†æˆæˆæƒç éªŒè¯ï¼‰
    async function validateAuthCode(code) {
      if (!code || !code.trim()) {
        showToast('è¯·è¾“å…¥æˆæƒç ', 'error');
        return false;
      }

      // ä½¿ç”¨æ–°çš„æˆæƒç ç®¡ç†ç³»ç»ŸéªŒè¯

      // ä½¿ç”¨æˆæƒç ç®¡ç†å™¨éªŒè¯
      const validationResult = licenseManagerV2.validateLicense(code.trim());

      if (validationResult.valid) {
        // è·å–æˆæƒç ä¿¡æ¯
        const licenseInfo = licenseManagerV2.getLicenseInfo(code.trim());

        // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
        currentUser = {
          userId: code.trim(),
          authCode: code.trim(),
          licenseType: licenseInfo.type,
          licenseName: licenseInfo.name,
          loginTime: new Date().toISOString()
        };

        // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜æˆæƒç 
        const isAdmin = code.trim().startsWith('PAIRING_ADMIN_');
        if (isAdmin) {
          currentUser.isAdmin = true;
        }

        try {
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
          await cloudDB.saveUser(currentUser);
          console.log('ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        } catch (error) {
          console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          // ç›´æ¥ä¿å­˜åˆ°localStorage
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        showMainInterface();

        // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
        await initUserData();

        // å°è¯•è¿ç§»æ—§æ ¼å¼æ•°æ®
        setTimeout(() => {
          migrateDataToCloud();
        }, 1000);

        showToast(`æˆæƒæˆåŠŸï¼${licenseInfo.name} - ${licenseInfo.features.join(', ')}`, 'success');
        return true;
      } else {
        showToast(validationResult.message, 'error');
        return false;
      }
    }

    // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
    async function initUserData() {
      // æ¸…ç©ºç°æœ‰æ•°æ®
      allFactors = [];
      correctAnswers = {};
      history = [];
      historyTags = [];

      // åŠ è½½ç”¨æˆ·æ•°æ®
      await loadUserData();

      // æ¸²æŸ“ç•Œé¢
      renderHistory();
      renderHistoryTags();
    }

    // åŠ è½½ç”¨æˆ·æ•°æ®
    async function loadUserData() {
      if (!currentUser) return;

      try {
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        const cardSets = await cloudDB.getCardSets(currentUser.userId);
        const tags = await cloudDB.getHistoryTags(currentUser.userId);

        history = cardSets || [];
        historyTags = tags || [];

        // æ¸²æŸ“æ•°æ®
        renderHistory();
        renderHistoryTags();

        console.log('âœ… æ•°æ®å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½');
      } catch (error) {
        console.error('âŒ ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®å¤±è´¥:', error);
        // å°è¯•ä»æ—§æ ¼å¼åŠ è½½
        const userHistory = localStorage.getItem(`history_${currentUser.userId}`);
        if (userHistory) {
          history = JSON.parse(userHistory);
        }
        const savedTags = localStorage.getItem(`cardSetHistoryTags_${currentUser.userId}`);
        if (savedTags) {
          historyTags = JSON.parse(savedTags);
        }
        renderHistory();
        renderHistoryTags();
        console.log('âœ… æ•°æ®å·²ä»æ—§æ ¼å¼åŠ è½½');
      }
    }

    // ä¿å­˜ç”¨æˆ·æ•°æ®
    async function saveUserData() {
      if (!currentUser) return;

      try {
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        await cloudDB.saveCardSets(currentUser.userId, history);
        await cloudDB.saveHistoryTags(currentUser.userId, historyTags);

        console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
      } catch (error) {
        console.error('âŒ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
        // ç›´æ¥ä¿å­˜åˆ°localStorage
        localStorage.setItem(`history_${currentUser.userId}`, JSON.stringify(history));
        localStorage.setItem(`cardSetHistoryTags_${currentUser.userId}`, JSON.stringify(historyTags));
        console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°localStorage');
      }
    }

    // æ•°æ®è¿ç§»å‡½æ•°
    async function migrateDataToCloud() {
      if (!currentUser) return;

      try {
        await cloudDB.migrateFromLocalStorage(currentUser.userId);
        showToast('æ—§æ ¼å¼æ•°æ®è¿ç§»å®Œæˆ', 'success');
      } catch (error) {
        console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
        showToast('æ•°æ®è¿ç§»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    // é€€å‡ºç™»å½•
    function logout() {
      showConfirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿå½“å‰æ•°æ®å·²ä¿å­˜ã€‚', () => {
        try {
          // ä¿å­˜å½“å‰æ•°æ®
          if (currentUser) {
            saveUserData();
          }

          // ä¿å­˜å½“å‰ç”¨æˆ·ä¿¡æ¯ç”¨äºæ ‡è®°æˆæƒç 
          const userAuthCode = currentUser ? currentUser.authCode : null;

          // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
          localStorage.removeItem('currentUser');
          currentUser = null;

          // æ¸…ç©ºç•Œé¢æ•°æ®
          allFactors = [];
          correctAnswers = {};
          history = [];
          historyTags = [];
          currentTags = [];
          reviewModeCallback = null;

          // æ¸…é™¤å¤ä¹ åŒºåŸŸçŠ¶æ€
          clearReviewData();

          // é€€å‡ºç™»å½•æ—¶ä¸æ ‡è®°æˆæƒç ä¸ºå·²ä½¿ç”¨ï¼Œå…è®¸ç”¨æˆ·é‡æ–°ç™»å½•
          if (userAuthCode) {
            console.log('ç”¨æˆ·é€€å‡ºç™»å½•ï¼Œæˆæƒç ä¿æŒå¯ç”¨çŠ¶æ€:', userAuthCode);
          }

          // æ¸²æŸ“ç©ºç•Œé¢
          renderHistory();
          renderHistoryTags();

          // æ˜¾ç¤ºæˆæƒç•Œé¢
          showAuthInterface();

          showToast('å·²é€€å‡ºç™»å½•', 'info');
        } catch (error) {
          console.error('é€€å‡ºç™»å½•æ—¶å‡ºé”™:', error);
          showToast('é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      });
    }

    // æ´—ç‰Œå‡½æ•°
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Toast æ¶ˆæ¯å‡½æ•°
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;

      container.appendChild(toast);

      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);

      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
    function showConfirm(message, onConfirm, onCancel) {
      const dialog = document.createElement('div');
      dialog.className = 'confirm-dialog';
      dialog.innerHTML = `
        <div class="dialog-content">
          <p>${message}</p>
          <div class="dialog-buttons">
            <button class="btn-cancel">å–æ¶ˆ</button>
            <button class="btn-confirm">ç¡®å®š</button>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      // ç»‘å®šäº‹ä»¶
      dialog.querySelector('.btn-cancel').onclick = () => {
        document.body.removeChild(dialog);
        if (onCancel) onCancel();
      };

      dialog.querySelector('.btn-confirm').onclick = () => {
        document.body.removeChild(dialog);
        if (onConfirm) onConfirm();
      };
    }

    // ä¼˜åŒ–åˆ†ç»„è¾“å…¥åŒºçš„æ·»åŠ å’Œåˆ é™¤
    document
      .getElementById("addGroup")
      .addEventListener("click", function () {
        const container = document.getElementById("groupContainer");
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-input";
        groupDiv.style.display = "flex";
        groupDiv.style.gap = "10px";
        groupDiv.style.alignItems = "flex-start";
        groupDiv.innerHTML = `
                <div style="flex:1;">
                    <input type="text" placeholder="åˆ†ç»„åç§°" class="group-name" style="width:100%;margin-bottom:6px;" />
                    <textarea placeholder="æ¡ç›®åˆ—è¡¨ (ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”)" class="group-items" style="width:100%;height:60px;"></textarea>
                </div>
                <button class="remove-group" style="background:#95a5a6;">åˆ é™¤</button>
            `;
        groupDiv.querySelector(".remove-group").onclick = function () {
          groupDiv.remove();
        };
        container.appendChild(groupDiv);
      });
    // é»˜è®¤åˆ†ç»„çš„åˆ é™¤æŒ‰é’®
    document.querySelector(".remove-group").onclick = function () {
      this.parentElement.remove();
    };

    document
      .getElementById("generate")
      .addEventListener("click", function () {
        // éªŒè¯é¢˜ç›®åç§°
        const titleInput = document.getElementById("cardSetTitle");
        const titleTip = document.getElementById("titleRequiredTip");
        if (!titleInput.value.trim()) {
          titleTip.style.display = "inline";
          titleInput.focus();
          showToast("è¯·è¾“å…¥é¢˜ç›®åç§°", "error");
          return;
        } else {
          titleTip.style.display = "none";
        }

        // éªŒè¯åˆ†ç»„æ•°é‡
        const groupNames = document.querySelectorAll(".group-name");
        const groupItems = document.querySelectorAll(".group-items");
        const validGroups = [];

        groupNames.forEach((nameInput, index) => {
          const groupName = nameInput.value.trim();
          if (!groupName) return;

          const items = groupItems[index].value
            .split(/[\n,]+/)
            .map((s) => s.trim())
            .filter((s) => s);

          if (items.length === 0) {
            showToast(`åˆ†ç»„"${groupName}"è‡³å°‘éœ€è¦1ä¸ªæ¡ç›®`, "error");
            groupItems[index].focus();
            return;
          }

          validGroups.push({ name: groupName, items: items });
        });

        if (validGroups.length < 2) {
          showToast("è‡³å°‘éœ€è¦2ä¸ªåˆ†ç»„", "error");
          return;
        }

        if (validGroups.length > 6) {
          showToast("æœ€å¤šæ”¯æŒ6ä¸ªåˆ†ç»„ï¼Œå½“å‰æœ‰" + validGroups.length + "ä¸ªåˆ†ç»„", "error");
          return;
        }

        // æ£€æŸ¥æ‰€æœ‰åˆ†ç»„å†…çš„é¡¹ç›®åç§°æ˜¯å¦æœ‰é‡å¤
        const allItems = [];
        const duplicateItems = [];

        validGroups.forEach((group) => {
          group.items.forEach((item) => {
            if (allItems.includes(item)) {
              duplicateItems.push(item);
            } else {
              allItems.push(item);
            }
          });
        });

        if (duplicateItems.length > 0) {
          const uniqueDuplicates = [...new Set(duplicateItems)];
          showToast(`æ·»åŠ å¤±è´¥ï¼šé¡¹ç›®åç§°"${uniqueDuplicates.join('ã€')}"é‡å¤ï¼Œè¯·é‡æ–°ç¼–è¾‘`, "error");
          return;
        }

        allFactors = [];
        correctAnswers = {};

        validGroups.forEach((group) => {
          group.items.forEach((item) => {
            allFactors.push({ text: item, group: group.name, correct: false });
          });
          correctAnswers[group.name] = group.items;
        });

        const cardSetTitle =
          titleInput.value.trim() || `å¡ç»„${history.length + 1}`;

        history.push({
          title: cardSetTitle,
          tags: [...currentTags], // ä½¿ç”¨å½“å‰æ ‡ç­¾æ•°ç»„
          factors: JSON.parse(JSON.stringify(allFactors)),
          correctAnswers: JSON.parse(JSON.stringify(correctAnswers)),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        (async function () {
          await saveHistory();
          renderHistory();
        })();
        renderMatchingArea(allFactors, correctAnswers);
        // æ˜¾ç¤ºå¤ä¹ åŒºåŸŸ
        document.getElementById("reviewSection").style.display = "block";

        // æ¸…é™¤æ‰€æœ‰è¾“å…¥æ¡†
        clearAllInputs();
        renderHistory(); // å†æ¬¡åˆ·æ–°å†å²åŒº
      });

    // åˆ†é¡µå˜é‡
    let currentHistoryPage = 1;
    const historyPageSize = 10;

    function renderHistory(filteredHistory = null, page = 1) {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";

      // ç¡®ä¿ history æ˜¯æ•°ç»„
      if (!Array.isArray(history)) {
        history = [];
      }

      const displayHistory = filteredHistory || history;

      // ç¡®ä¿ displayHistory æ˜¯æ•°ç»„
      if (!Array.isArray(displayHistory)) {
        displayHistory = [];
      }

      if (displayHistory.length === 0) {
        const noResultDiv = document.createElement("div");
        noResultDiv.style.textAlign = "center";
        noResultDiv.style.color = "#666";
        noResultDiv.style.padding = "20px";
        noResultDiv.textContent = filteredHistory ? "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¡ç»„" : "æš‚æ— å†å²å¡ç»„";
        historyList.appendChild(noResultDiv);
        return;
      }

      // è®¡ç®—åˆ†é¡µ
      const totalPages = Math.ceil(displayHistory.length / historyPageSize);
      const startIndex = (page - 1) * historyPageSize;
      const endIndex = startIndex + historyPageSize;
      const currentPageData = displayHistory.slice(startIndex, endIndex);

      // æ›´æ–°å½“å‰é¡µç 
      currentHistoryPage = page;

      currentPageData.forEach((entry, index) => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "history-card";
        cardDiv.style.cssText = `
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        `;

        const globalIndex = startIndex + index;
        cardDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h3 style="margin: 0; color: #2c3e50; font-size: 1.1em;">${entry.title || `å¡ç»„ ${globalIndex + 1}`}</h3>
            <div style="display: flex; gap: 5px;">
                      <button class="edit-card" style="background: #e67e22; padding: 4px 8px; font-size: 0.8em; border: none; color: white; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
        <button class="delete-card" style="background: #95a5a6; padding: 4px 8px; font-size: 0.8em; border: none; color: white; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
            </div>
          </div>
          <div style="margin-bottom: 8px;">
            ${entry.tags && entry.tags.length > 0 ?
            `<div style="display: flex; flex-wrap: wrap; gap: 4px;">
                ${entry.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 12px; font-size: 0.8em;">${tag}</span>`).join('')}
              </div>` :
            '<span style="color: #999; font-size: 0.9em;">æ— æ ‡ç­¾</span>'
          }
          </div>
          <div style="color: #666; font-size: 0.9em;">
            åˆ›å»ºæ—¶é—´: ${new Date(entry.createdAt).toLocaleString()}
          </div>
        `;

        // ç‚¹å‡»å¡ç‰‡è¿›å…¥å¤ä¹ æ¨¡å¼
        cardDiv.addEventListener("click", (e) => {
          if (!e.target.classList.contains('edit-card') && !e.target.classList.contains('delete-card')) {
            const originalIndex = history.indexOf(entry);
            showReviewModePopup((mode) => chooseHistoryMode(originalIndex, mode));
          }
        });

        // ç¼–è¾‘æŒ‰é’®
        cardDiv.querySelector('.edit-card').addEventListener("click", (e) => {
          e.stopPropagation();
          editCard(entry, history.indexOf(entry));
        });

        // åˆ é™¤æŒ‰é’®
        cardDiv.querySelector('.delete-card').addEventListener("click", (e) => {
          e.stopPropagation();
          deleteCard(history.indexOf(entry));
        });

        historyList.appendChild(cardDiv);
      });

      // æ·»åŠ åˆ†é¡µæ§ä»¶
      if (totalPages > 1) {
        const paginationDiv = document.createElement("div");
        paginationDiv.style.cssText = `
          display: flex;
          justify-content: center;
          align-items: center;
          margin-top: 20px;
          gap: 10px;
        `;

        // ä¸Šä¸€é¡µæŒ‰é’®
        if (page > 1) {
          const prevBtn = document.createElement("button");
          prevBtn.textContent = "ä¸Šä¸€é¡µ";
          prevBtn.style.cssText = `
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
          `;
          prevBtn.onclick = () => renderHistory(filteredHistory, page - 1);
          paginationDiv.appendChild(prevBtn);
        }

        // é¡µç æ˜¾ç¤º
        const pageInfo = document.createElement("span");
        pageInfo.textContent = `ç¬¬ ${page} é¡µï¼Œå…± ${totalPages} é¡µ`;
        pageInfo.style.cssText = `
          padding: 8px 12px;
          color: #666;
        `;
        paginationDiv.appendChild(pageInfo);

        // ä¸‹ä¸€é¡µæŒ‰é’®
        if (page < totalPages) {
          const nextBtn = document.createElement("button");
          nextBtn.textContent = "ä¸‹ä¸€é¡µ";
          nextBtn.style.cssText = `
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
          `;
          nextBtn.onclick = () => renderHistory(filteredHistory, page + 1);
          paginationDiv.appendChild(nextBtn);
        }

        historyList.appendChild(paginationDiv);
      }
    }

    // æ–°å¢ï¼šå¼¹çª—é€‰æ‹©å¤ä¹ æ¨¡å¼
    function showReviewModePopup(callback) {
      reviewModeCallback = callback;
      document.getElementById("reviewModePopup").style.display = "flex";
    }
    document.getElementById("reviewAllBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
      if (reviewModeCallback) reviewModeCallback("all");
    };
    document.getElementById("reviewWrongBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
      if (reviewModeCallback) reviewModeCallback("wrong");
    };
    document.getElementById("cancelReviewBtn").onclick = function () {
      document.getElementById("reviewModePopup").style.display = "none";
    };

    function chooseHistoryMode(index, mode) {
      const entry = history[index];
      if (mode === "all") {
        // æ‰“ä¹±factorsé¡ºåº
        const shuffled = shuffleArray(entry.factors.slice());
        allFactors = shuffled;
        correctAnswers = entry.correctAnswers;
        renderMatchingArea(shuffled, entry.correctAnswers);
        // æ˜¾ç¤ºå¤ä¹ åŒºåŸŸ
        document.getElementById("reviewSection").style.display = "block";
      } else if (mode === "wrong") {
        const wrongFactors = entry.factors.filter((f) => f.correct === false);
        const wrongAnswers = {};
        Object.keys(entry.correctAnswers).forEach((groupName) => {
          const filtered = entry.correctAnswers[groupName].filter((item) =>
            wrongFactors.find((f) => f.text === item)
          );
          if (filtered.length > 0) wrongAnswers[groupName] = filtered;
        });
        if (Object.keys(wrongAnswers).length === 0) {
          showToast("è¯¥å¡ç»„æ²¡æœ‰å†å²é”™é¢˜ï¼", "warning");
          return;
        }
        allFactors = wrongFactors;
        correctAnswers = wrongAnswers;
        renderMatchingArea(wrongFactors, wrongAnswers);
        // æ˜¾ç¤ºå¤ä¹ åŒºåŸŸ
        document.getElementById("reviewSection").style.display = "block";
      }
    }

    function renderMatchingArea(factors, answers) {
      const matchingArea = document.getElementById("matchingArea");
      matchingArea.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "grid";
      grid.id = "itemPool";

      factors.forEach((factor) => {
        const div = createDraggableItem(factor.text, factor.group);
        grid.appendChild(div);
      });

      matchingArea.appendChild(grid);

      const columns = document.createElement("div");
      columns.className = "columns";

      Object.keys(answers).forEach((groupName) => {
        const question = document.createElement("div");
        question.className = "question";
        question.innerHTML = `<strong>${groupName}ï¼š</strong>`;

        // dropzone wrapper
        const dropzoneWrapper = document.createElement("div");
        dropzoneWrapper.className = "dropzone-wrapper";

        // ä¸» dropzone
        const dropzone = document.createElement("div");
        dropzone.className = "dropzone";
        dropzone.dataset.group = groupName;

        enableDrop(dropzone);

        dropzoneWrapper.appendChild(dropzone);

        // åˆæ¬¡æ¸²æŸ“æ—¶å°±åˆ†åˆ—
        splitDropzoneColumns(dropzone, dropzoneWrapper);

        // ç»“æœåŒºåŸŸ
        const resultDiv = document.createElement("div");
        resultDiv.className = "result";
        resultDiv.id = "result-" + groupName;

        question.appendChild(dropzoneWrapper);
        question.appendChild(resultDiv);
        columns.appendChild(question);

        // --- å¤šæ åˆ†å‰² ---
        dropzone.addEventListener("DOMSubtreeModified", function () {
          splitDropzoneColumns(dropzone, dropzoneWrapper);
        });
      });

      matchingArea.appendChild(columns);

      document.getElementById("checkAnswers").style.display = "inline-block";
    }

    // å¤šæ åˆ†å‰²é€»è¾‘
    function splitDropzoneColumns(dropzone, wrapper) {
      if (!dropzone || !wrapper) return;
      // æ”¶é›†æ‰€æœ‰ item
      let items = [];
      wrapper.querySelectorAll(".dropzone, .dropzone-col").forEach((col) => {
        items = items.concat(Array.from(col.children));
      });
      // æ¸…ç©º wrapper
      wrapper.innerHTML = "";

      // è®¡ç®—æ æ•°
      let colCount = 1;
      if (items.length > 3) colCount = 2;
      if (items.length > 6) colCount = 3;
      if (items.length > 12) colCount = 4;

      // åˆ†é…åˆ°å¤šæ 
      const columns = Array.from({ length: colCount }, () => []);
      items.forEach((item, idx) => {
        columns[idx % colCount].push(item);
      });

      // åˆ›å»ºæ–°æ 
      for (let i = 0; i < colCount; i++) {
        const colDiv = document.createElement("div");
        colDiv.className = i === 0 ? "dropzone" : "dropzone-col";
        colDiv.style.display = "flex";
        colDiv.style.flexDirection = "column";
        colDiv.style.flex = "1 1 0";
        colDiv.style.gap = "4px";
        colDiv.style.minWidth = "60px";
        columns[i].forEach((item) => colDiv.appendChild(item));
        // åªä¸»æ å¯æ‹–æ‹½
        if (i === 0) enableDrop(colDiv);
        wrapper.appendChild(colDiv);
      }
    }

    function createDraggableItem(text, group) {
      const div = document.createElement("div");
      div.className = "item";
      div.draggable = true;
      div.textContent = text;
      div.dataset.group = group;

      div.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ text, group }));
      });

      return div;
    }

    function enableDrop(dropzone) {
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("over");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("over");
      });

      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("over");
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));

        removeItemFromAll(data.text);

        const itemDiv = createDraggableItem(data.text, data.group);
        dropzone.appendChild(itemDiv);
      });
    }

    document.addEventListener("dragend", function (e) {
      const itemPool = document.getElementById("itemPool");
      if (e.target.classList.contains("item")) {
        const rect = itemPool.getBoundingClientRect();
        if (
          e.pageX >= rect.left &&
          e.pageX <= rect.right &&
          e.pageY >= rect.top &&
          e.pageY <= rect.bottom
        ) {
          removeItemFromAll(e.target.textContent);
          itemPool.appendChild(e.target);
        }
      }
    });

    function removeItemFromAll(text) {
      document.querySelectorAll(".item").forEach((item) => {
        if (item.textContent === text) {
          item.remove();
        }
      });
    }

    document
      .getElementById("checkAnswers")
      .addEventListener("click", function () {
        // é‡ç½®æ‰€æœ‰itemçš„é¢œè‰²
        document.querySelectorAll(".item").forEach((item) => {
          item.classList.remove("correct", "incorrect");
        });

        // éšè—"å†æ¥ä¸€é"æŒ‰é’®
        document.getElementById("restartBtn").style.display = "none";

        Object.keys(correctAnswers).forEach((groupName) => {
          // æœ€ç®€å•çš„æ–¹æ³•ï¼šç›´æ¥æŸ¥æ‰¾æ‰€æœ‰åœ¨åˆ†ç±»åŒºåŸŸå†…çš„item
          const allItems = document.querySelectorAll('.item');
          let items = [];

          // æ‰¾åˆ°æ‰€æœ‰ä¸åœ¨itemPoolä¸­çš„itemï¼ˆå³å·²ç»æ‹–å…¥åˆ†ç±»åŒºåŸŸçš„itemï¼‰
          allItems.forEach(item => {
            const parent = item.parentElement;
            // æ£€æŸ¥itemæ˜¯å¦åœ¨åˆ†ç±»åŒºåŸŸå†…ï¼ˆä¸åœ¨itemPoolä¸­ï¼‰
            if (parent && !parent.id.includes('itemPool')) {
              // æ£€æŸ¥è¿™ä¸ªitemæ˜¯å¦åœ¨å½“å‰åˆ†ç±»çš„åŒºåŸŸå†…
              const questionDiv = parent.closest('.question');
              if (questionDiv) {
                const questionTitle = questionDiv.querySelector('strong');
                if (questionTitle && questionTitle.textContent.includes(groupName)) {
                  items.push(item);
                }
              }
            }
          });

          // è°ƒè¯•ä¿¡æ¯
          console.log(`[${groupName}] æ‰¾åˆ° ${items.length} ä¸ªitem:`, items.map(item => item.textContent));

          // è·å–è¯¥åˆ†ç±»çš„æ­£ç¡®ç­”æ¡ˆé›†åˆ
          const correctSet = new Set(correctAnswers[groupName]);
          let correctCount = 0;
          let answeredCount = 0;

          items.forEach((item) => {
            answeredCount++;
            // æ ¹æ®itemåŸæœ¬æ‰€å±çš„ç±»åˆ«åˆ¤æ–­æ­£ç¡®æ€§
            const itemOriginalGroup = item.dataset.group;
            const isCorrect = itemOriginalGroup === groupName;



            if (isCorrect) {
              item.classList.add("correct");
              item.classList.remove("incorrect");
              correctCount++;
            } else {
              item.classList.add("incorrect");
              item.classList.remove("correct");
            }

            // æ›´æ–°allFactorsä¸­çš„æ­£ç¡®æ€§çŠ¶æ€
            allFactors.forEach((f) => {
              if (f.text === item.textContent) {
                f.correct = isCorrect;
              }
            });
          });

          const resultDiv = document.getElementById("result-" + groupName);
          if (answeredCount > 0) {
            resultDiv.textContent = `å·²ä½œç­”ï¼š${answeredCount}ä¸ªï¼Œæ­£ç¡®ï¼š${correctCount}ä¸ª / æ€»è®¡ï¼š${correctAnswers[groupName].length}ä¸ª`;
          } else {
            resultDiv.textContent = `æœªä½œç­” / æ€»è®¡ï¼š${correctAnswers[groupName].length}ä¸ª`;
          }
        });

        // è¦†ç›–åŒæ­¥åˆ°å†å²å¡ç»„
        history.forEach((entry) => {
          entry.factors.forEach((f) => {
            const updated = allFactors.find((af) => af.text === f.text);
            if (updated) f.correct = updated.correct;
          });
        });
        (async function () {
          await saveHistory();
        })();

        // æ–°å¢ï¼šå¦‚æœæ‰€æœ‰iteméƒ½è¢«æ‹–å…¥åˆ†ç±»æ ï¼Œåˆ™é”å®šæ‰€æœ‰åˆ†ç±»æ å†…çš„itemï¼Œå¹¶æ˜¾ç¤º"å†æ¥ä¸€é"æŒ‰é’®
        const itemPool = document.getElementById("itemPool");
        if (itemPool && itemPool.children.length === 0) {
          document.querySelectorAll('.question .item').forEach(item => {
            item.draggable = false;
            item.classList.add('locked');
          });
          // æ˜¾ç¤º"å†æ¥ä¸€é"æŒ‰é’®
          document.getElementById("restartBtn").style.display = "inline-block";
        }
      });

    async function saveHistory() {
      if (currentUser) {
        try {
          await cloudDB.saveCardSets(currentUser.userId, history);
          console.log('å†å²å¡ç»„å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        } catch (error) {
          console.error('ä¿å­˜å†å²å¡ç»„å¤±è´¥ï¼Œä½¿ç”¨localStorage:', error);
          localStorage.setItem(`history_${currentUser.userId}`, JSON.stringify(history));
        }
      }
    }

    function backupHistory() {
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
      const key = "cardGroupHistory_backup_" + dateStr;
      localStorage.setItem(key, JSON.stringify(history));
    }

    // å¯åŠ¨æ—¶ç«‹å³å¤‡ä»½ä¸€æ¬¡
    backupHistory();
    // æ¯24å°æ—¶å¤‡ä»½ä¸€æ¬¡
    setInterval(backupHistory, 24 * 60 * 60 * 1000);

    // ç¼–è¾‘å¡ç»„åŠŸèƒ½
    function editCard(entry, index) {
      // åˆ›å»ºç¼–è¾‘å¼¹çª—
      const editModal = document.createElement('div');
      editModal.className = 'modal';
      editModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;

      editModal.innerHTML = `
        <div class="modal-content" style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          width: 80%;
          max-width: 800px;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #333; font-size: 24px;">ç¼–è¾‘å¡ç»„</h2>
            <button id="closeEditModal" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #666;
              padding: 0;
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
            ">&times;</button>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">å¡ç»„åç§°ï¼š</label>
            <input type="text" id="editCardTitle" value="${entry.title || ''}" style="
              width: 100%;
              padding: 12px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 16px;
              box-sizing: border-box;
            " placeholder="è¯·è¾“å…¥å¡ç»„åç§°">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">æ ‡ç­¾ï¼š</label>
            <div id="editTagsContainer" style="margin-bottom: 10px; min-height: 30px;"></div>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="editTagInput" placeholder="è¾“å…¥æ ‡ç­¾" style="
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                box-sizing: border-box;
              ">
              <button id="addEditTag" style="
                padding: 8px 16px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">æ·»åŠ æ ‡ç­¾</button>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">åˆ†ç»„å†…å®¹ï¼š</label>
            <div id="editGroupContainer"></div>
            <button id="addEditGroup" style="
              margin-top: 10px;
              padding: 8px 16px;
              background: #28a745;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#1e7e34'" onmouseout="this.style.backgroundColor='#28a745'">æ·»åŠ åˆ†ç»„</button>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <button id="cancelEdit" style="
              padding: 12px 24px;
              background: #6c757d;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#545b62'" onmouseout="this.style.backgroundColor='#6c757d'">å–æ¶ˆ</button>
            <button id="saveEdit" style="
              padding: 12px 24px;
              background: #007bff;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">ä¿å­˜ä¿®æ”¹</button>
          </div>
        </div>
      `;

      document.body.appendChild(editModal);

      // åˆå§‹åŒ–ç¼–è¾‘æ•°æ®
      let editTags = entry.tags ? [...entry.tags] : [];
      let editGroups = {};

      // æ ¹æ®å¡ç»„æ•°æ®é‡æ–°åˆ›å»ºåˆ†ç»„
      entry.factors.forEach((factor) => {
        if (!editGroups[factor.group]) {
          editGroups[factor.group] = [];
        }
        editGroups[factor.group].push(factor.text);
      });

      // æ¸²æŸ“æ ‡ç­¾
      function renderEditTags() {
        const container = document.getElementById('editTagsContainer');
        container.innerHTML = editTags.map(tag => `
          <span style="
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 2px;
          ">
            ${tag}
            <span onclick="removeEditTag('${tag}')" style="cursor: pointer; margin-left: 4px; color: #1976d2; font-weight: bold; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">Ã—</span>
          </span>
        `).join('');
      }

      // æ¸²æŸ“åˆ†ç»„
      function renderEditGroups() {
        const container = document.getElementById('editGroupContainer');
        container.innerHTML = Object.keys(editGroups).map(groupName => `
          <div style="
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <input type="text" class="edit-group-name" value="${groupName}" placeholder="åˆ†ç»„åç§°" style="
                flex: 1;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                margin-right: 15px;
                font-size: 14px;
                box-sizing: border-box;
              ">
              <button onclick="removeEditGroup('${groupName}')" style="
                padding: 8px 16px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='#c82333'" onmouseout="this.style.backgroundColor='#dc3545'">åˆ é™¤åˆ†ç»„</button>
            </div>
            <textarea class="edit-group-items" placeholder="è¯·è¾“å…¥è¯¥åˆ†ç»„çš„é¡¹ç›®ï¼Œæ¯è¡Œä¸€ä¸ªæˆ–é€—å·åˆ†éš”" style="
              width: 100%;
              min-height: 100px;
              padding: 12px;
              border: 1px solid #ddd;
              border-radius: 6px;
              resize: vertical;
              font-size: 14px;
              line-height: 1.5;
              box-sizing: border-box;
            ">${editGroups[groupName].join('\n')}</textarea>
          </div>
        `).join('');
      }

      // æ·»åŠ æ ‡ç­¾
      window.addEditTag = function () {
        const input = document.getElementById('editTagInput');
        const tag = input.value.trim();
        if (tag && !editTags.includes(tag)) {
          editTags.push(tag);
          renderEditTags();
          input.value = '';
        }
      };

      // åˆ é™¤æ ‡ç­¾
      window.removeEditTag = function (tag) {
        editTags = editTags.filter(t => t !== tag);
        renderEditTags();
      };

      // æ·»åŠ åˆ†ç»„
      window.addEditGroup = function () {
        const groupName = `åˆ†ç»„${Object.keys(editGroups).length + 1}`;
        editGroups[groupName] = [];
        renderEditGroups();
      };

      // åˆ é™¤åˆ†ç»„
      window.removeEditGroup = function (groupName) {
        delete editGroups[groupName];
        renderEditGroups();
      };

      // ä¿å­˜ä¿®æ”¹
      window.saveEditChanges = function () {
        const title = document.getElementById('editCardTitle').value.trim();
        if (!title) {
          showToast('è¯·è¾“å…¥å¡ç»„åç§°', 'error');
          return;
        }

        // æ”¶é›†åˆ†ç»„æ•°æ®
        const groupElements = document.querySelectorAll('#editGroupContainer > div');
        const newGroups = {};

        groupElements.forEach(element => {
          const nameInput = element.querySelector('.edit-group-name');
          const itemsTextarea = element.querySelector('.edit-group-items');

          if (nameInput && itemsTextarea) {
            const groupName = nameInput.value.trim();
            if (groupName) {
              const items = itemsTextarea.value
                .split(/[\n,]+/)
                .map(s => s.trim())
                .filter(s => s);

              if (items.length > 0) {
                newGroups[groupName] = items;
              }
            }
          }
        });

        if (Object.keys(newGroups).length < 2) {
          showToast('è‡³å°‘éœ€è¦2ä¸ªåˆ†ç»„', 'error');
          return;
        }

        // æ£€æŸ¥å¡ç»„åç§°æ˜¯å¦é‡å¤ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„å¡ç»„ï¼‰
        const existingCard = history.find((card, i) => i !== index && card.title === title);
        if (existingCard) {
          showToast(`å¡ç»„åç§°"${title}"å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`, 'error');
          return;
        }

        // æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦æœ‰é‡å¤
        const allItems = [];
        const duplicateItems = [];

        Object.values(newGroups).forEach(items => {
          items.forEach(item => {
            if (allItems.includes(item)) {
              duplicateItems.push(item);
            } else {
              allItems.push(item);
            }
          });
        });

        if (duplicateItems.length > 0) {
          const uniqueDuplicates = [...new Set(duplicateItems)];
          showToast(`ä¿®æ”¹å¤±è´¥ï¼šé¡¹ç›®åç§°"${uniqueDuplicates.join('ã€')}"é‡å¤ï¼Œè¯·é‡æ–°ç¼–è¾‘`, 'error');
          return;
        }

        // æ›´æ–°å†å²è®°å½•
        const newFactors = [];
        const newCorrectAnswers = {};

        Object.keys(newGroups).forEach(groupName => {
          newGroups[groupName].forEach(item => {
            newFactors.push({ text: item, group: groupName, correct: false });
          });
          newCorrectAnswers[groupName] = newGroups[groupName];
        });

        history[index] = {
          title: title,
          tags: editTags,
          factors: JSON.parse(JSON.stringify(newFactors)),
          correctAnswers: JSON.parse(JSON.stringify(newCorrectAnswers)),
          createdAt: history[index].createdAt,
          updatedAt: new Date().toISOString()
        };

        (async function () {
          await saveHistory();
          renderHistory();
        })();

        showToast('å¡ç»„æ›´æ–°æˆåŠŸï¼', 'success');
        closeEditModal();
      };

      // å…³é—­å¼¹çª—
      function closeEditModal() {
        document.body.removeChild(editModal);
        // æ¸…ç†å…¨å±€å‡½æ•°
        delete window.addEditTag;
        delete window.removeEditTag;
        delete window.addEditGroup;
        delete window.removeEditGroup;
        delete window.saveEditChanges;
      }

      // ç»‘å®šäº‹ä»¶
      document.getElementById('closeEditModal').onclick = closeEditModal;
      document.getElementById('cancelEdit').onclick = closeEditModal;
      document.getElementById('addEditTag').onclick = window.addEditTag;
      document.getElementById('addEditGroup').onclick = window.addEditGroup;
      document.getElementById('saveEdit').onclick = window.saveEditChanges;

      // æ ‡ç­¾è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      document.getElementById('editTagInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          window.addEditTag();
        }
      });

      // åˆå§‹åŒ–æ¸²æŸ“
      renderEditTags();
      renderEditGroups();
    }



    // åˆ é™¤å¡ç»„
    function deleteCard(index) {
      showConfirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚", () => {
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤ä¹ è¢«åˆ é™¤çš„å¡ç»„
        const deletedCard = history[index];
        const isCurrentlyReviewing = allFactors.length > 0 &&
          allFactors.some(factor =>
            deletedCard.factors.some(f => f.text === factor.text)
          );

        // åˆ é™¤å¡ç»„
        history.splice(index, 1);
        (async function () {
          await saveHistory();
          renderHistory();
        })();

        // å¦‚æœæ­£åœ¨å¤ä¹ è¢«åˆ é™¤çš„å¡ç»„ï¼Œæ¸…é™¤å¤ä¹ æ•°æ®
        if (isCurrentlyReviewing) {
          clearReviewData();
          showToast("å¡ç»„å·²åˆ é™¤ï¼æ­£åœ¨å¤ä¹ çš„æ•°æ®å·²æ¸…é™¤ã€‚", "success");
        } else {
          showToast("å¡ç»„å·²åˆ é™¤ï¼", "success");
        }
      });
    }

    // æ¸…é™¤å¤ä¹ æ•°æ®
    function clearReviewData() {
      allFactors = [];
      correctAnswers = {};
      document.getElementById("matchingArea").innerHTML = "";
      document.getElementById("checkAnswers").style.display = "none";
      document.getElementById("restartBtn").style.display = "none";
      // éšè—å¤ä¹ åŒºåŸŸ
      document.getElementById("reviewSection").style.display = "none";
    }

    // æ ‡ç­¾ç®¡ç†
    // åŠ è½½å†å²æ ‡ç­¾æ± 
    async function loadHistoryTags() {
      if (!currentUser) return;
      try {
        historyTags = await cloudDB.getHistoryTags(currentUser.userId);
        console.log('å†å²æ ‡ç­¾å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½');
      } catch (error) {
        console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²æ ‡ç­¾å¤±è´¥ï¼Œä½¿ç”¨æ—§æ ¼å¼:', error);
        const saved = localStorage.getItem(`cardSetHistoryTags_${currentUser.userId}`);
        if (saved) {
          historyTags = JSON.parse(saved);
        } else {
          historyTags = [];
        }
      }
    }
    // ä¿å­˜å†å²æ ‡ç­¾æ± 
    async function saveHistoryTags() {
      if (!currentUser) return;
      try {
        await cloudDB.saveHistoryTags(currentUser.userId, historyTags);
        console.log('å†å²æ ‡ç­¾å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
      } catch (error) {
        console.error('ä¿å­˜å†å²æ ‡ç­¾å¤±è´¥ï¼Œä½¿ç”¨localStorage:', error);
        localStorage.setItem(`cardSetHistoryTags_${currentUser.userId}`, JSON.stringify(historyTags));
      }
    }
    // æ·»åŠ åˆ°å†å²æ ‡ç­¾æ± 
    function addToHistoryTags(tag) {
      if (!historyTags.includes(tag)) {
        historyTags.unshift(tag);
        // æœ€å¤šä¿å­˜40ä¸ª
        if (historyTags.length > 40) historyTags = historyTags.slice(0, 40);
        (async function () {
          await saveHistoryTags();
        })();
      } else {
        // ç§»åˆ°æœ€å‰
        historyTags = [tag, ...historyTags.filter(t => t !== tag)];
        (async function () {
          await saveHistoryTags();
        })();
      }
    }

    // æ·»åŠ æ ‡ç­¾
    function addTag(tagText) {
      const trimmedTag = tagText.trim();
      if (trimmedTag && !currentTags.includes(trimmedTag)) {
        currentTags.unshift(trimmedTag); // æœ€æ–°åœ¨å‰
        addToHistoryTags(trimmedTag);
        renderTags();
        renderHistoryTags();
        document.getElementById("cardSetTags").value = "";
      }
    }
    // åˆ é™¤æ ‡ç­¾
    function removeTag(tagText) {
      currentTags = currentTags.filter(tag => tag !== tagText);
      renderTags();
      renderHistoryTags();
    }
    // æ¸²æŸ“æ ‡ç­¾
    function renderTags() {
      const container = document.getElementById("tagsContainer");
      container.innerHTML = "";
      const maxTags = 16;
      const displayTags = currentTags.slice(0, maxTags);
      displayTags.forEach(tag => {
        const tagElement = document.createElement("div");
        tagElement.className = "tag";
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button class="remove-tag" onclick="removeTag('${tag}')" title="åˆ é™¤æ ‡ç­¾">Ã—</button>
        `;
        container.appendChild(tagElement);
      });
      if (currentTags.length > maxTags) {
        const moreElement = document.createElement("div");
        moreElement.className = "tag";
        moreElement.style.background = "#f5f5f5";
        moreElement.style.color = "#666";
        moreElement.style.cursor = "default";
        moreElement.innerHTML = `<span>+${currentTags.length - maxTags}ä¸ª</span>`;
        container.appendChild(moreElement);
      }
    }
    // åˆ é™¤å†å²æ ‡ç­¾
    function removeHistoryTag(tagText) {
      historyTags = historyTags.filter(tag => tag !== tagText);
      (async function () {
        await saveHistoryTags();
      })();
      renderHistoryTags();
      showToast(`å·²åˆ é™¤å†å²æ ‡ç­¾"${tagText}"`, "success");
    }

    // æ¸²æŸ“å†å²æ ‡ç­¾åŒº
    function renderHistoryTags() {
      const container = document.getElementById("historyTagsContainer");
      container.innerHTML = "";

      // ç¡®ä¿ currentTags æ˜¯æ•°ç»„
      if (!Array.isArray(currentTags)) {
        currentTags = [];
      }

      // åªæ˜¾ç¤ºæœªé€‰ä¸­çš„å†å²æ ‡ç­¾ï¼Œæœ€æ–°åœ¨å‰ï¼Œæœ€å¤š2è¡Œ16ä¸ª
      const displayTags = historyTags.filter(tag => !currentTags.includes(tag)).slice(0, 16);
      displayTags.forEach(tag => {
        const tagElement = document.createElement("div");
        tagElement.className = "tag selectable";
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button class="remove-tag" onclick="removeHistoryTag('${tag}')" title="åˆ é™¤å†å²æ ‡ç­¾">Ã—</button>
        `;
        tagElement.onclick = function (e) {
          // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘é€‰æ‹©
          if (e.target.classList.contains('remove-tag')) {
            return;
          }
          addTag(tag);
        };
        container.appendChild(tagElement);
      });
      if (historyTags.filter(tag => !currentTags.includes(tag)).length > 16) {
        const moreElement = document.createElement("div");
        moreElement.className = "tag selectable";
        moreElement.style.background = "#f5f5f5";
        moreElement.style.color = "#666";
        moreElement.style.cursor = "default";
        moreElement.innerHTML = `<span>+${historyTags.length - 16}ä¸ª</span>`;
        container.appendChild(moreElement);
      }
    }

    // æœç´¢åŠŸèƒ½
    document.getElementById("searchBtn").addEventListener("click", function () {
      const searchTerm = document.getElementById("searchTags").value.trim().toLowerCase();
      if (!searchTerm) {
        renderHistory();
        return;
      }

      const filteredHistory = history.filter(entry => {
        // æœç´¢æ ‡é¢˜
        if (entry.title && entry.title.toLowerCase().includes(searchTerm)) {
          return true;
        }
        // æœç´¢æ ‡ç­¾
        if (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchTerm))) {
          return true;
        }
        return false;
      });

      renderHistory(filteredHistory);
    });

    // æ¸…é™¤æœç´¢
    document.getElementById("clearSearchBtn").addEventListener("click", function () {
      document.getElementById("searchTags").value = "";
      renderHistory();
    });

    // æ ‡ç­¾è¾“å…¥äº‹ä»¶
    document.getElementById("cardSetTags").addEventListener("keydown", function (e) {
      if (e.key === "Enter" || e.key === ",") {
        e.preventDefault();
        const value = this.value;
        if (e.key === ",") {
          const parts = value.split(",");
          if (parts.length > 1) {
            addTag(parts[0]);
            this.value = parts.slice(1).join(",");
          }
        } else {
          addTag(value);
        }
      }
    });
    document.getElementById("cardSetTags").addEventListener("blur", function () {
      if (this.value.trim()) {
        addTag(this.value);
      }
    });

    // æ–°å»ºå¡ç»„æŒ‰é’®
    document.getElementById("newCard").addEventListener("click", function () {
      resetForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // å†æ¥ä¸€éæŒ‰é’®
    document.getElementById("restartBtn").addEventListener("click", function () {
      showReviewModePopup((mode) => {
        if (mode === "all") {
          // å…¨éƒ¨æ‰“ä¹±å¤ä¹ 
          const shuffled = shuffleArray(allFactors.slice());
          renderMatchingArea(shuffled, correctAnswers);
          // æ˜¾ç¤ºå¤ä¹ åŒºåŸŸ
          document.getElementById("reviewSection").style.display = "block";
          // éšè—"å†æ¥ä¸€é"æŒ‰é’®
          document.getElementById("restartBtn").style.display = "none";
        } else if (mode === "wrong") {
          // åªå¤ä¹ é”™é¢˜
          const wrongFactors = allFactors.filter((f) => f.correct === false);
          const wrongAnswers = {};
          Object.keys(correctAnswers).forEach((groupName) => {
            const filtered = correctAnswers[groupName].filter((item) =>
              wrongFactors.find((f) => f.text === item)
            );
            if (filtered.length > 0) wrongAnswers[groupName] = filtered;
          });
          if (Object.keys(wrongAnswers).length === 0) {
            showToast("æ²¡æœ‰é”™é¢˜éœ€è¦å¤ä¹ ï¼", "warning");
            return;
          }
          renderMatchingArea(wrongFactors, wrongAnswers);
          // æ˜¾ç¤ºå¤ä¹ åŒºåŸŸ
          document.getElementById("reviewSection").style.display = "block";
          // éšè—"å†æ¥ä¸€é"æŒ‰é’®
          document.getElementById("restartBtn").style.display = "none";
        }
      });
    });

    // æ¸…é™¤æ‰€æœ‰è¾“å…¥æ¡†
    function clearAllInputs() {
      document.getElementById("cardSetTitle").value = "";
      document.getElementById("cardSetTags").value = "";
      currentTags = [];
      renderTags();
      renderHistoryTags();
      document.getElementById("groupContainer").innerHTML = `
        <div class="group-input">
          <div style="flex: 1">
            <input type="text" placeholder="åˆ†ç»„åç§° (å¦‚ï¼šä¿ƒè¿›èƒƒé…¸åˆ†æ³Œçš„å› ç´ )" class="group-name"
              style="width: 100%; margin-bottom: 6px" />
            <textarea placeholder="æ¡ç›®åˆ—è¡¨ (ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”)" class="group-items" style="width: 100%; height: 60px"></textarea>
          </div>
          <button class="remove-group" style="background: #95a5a6">åˆ é™¤</button>
        </div>
      `;

      // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®
      document.querySelector(".remove-group").onclick = function () {
        this.parentElement.remove();
      };
    }

    // æ•°æ®å¯¼å‡ºå¯¼å…¥å‡½æ•°
    async function exportAllData() {
      const exportData = {
        exportedAt: new Date().toISOString(),
        user: currentUser,
        history: history,
        historyTags: historyTags,
        version: "1.0"
      };

      try {
        const filename = `é…å¯¹é¢˜æ•°æ®_${new Date().toISOString().slice(0, 10)}.json`;
        const result = await window.electronAPI.exportFile(exportData, filename);

        if (result.success) {
          showToast('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    async function importData() {
      try {
        const result = await window.electronAPI.importFile();

        if (result.success) {
          const importData = result.data;

          if (!importData.history || !Array.isArray(importData.history)) {
            showToast('å¯¼å…¥æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
            return;
          }

          // ç¡®è®¤å¯¼å…¥
          const confirmResult = await window.electronAPI.showConfirmDialog({
            title: 'ç¡®è®¤å¯¼å…¥',
            message: `ç¡®å®šè¦å¯¼å…¥ ${importData.history.length} ä¸ªå¡ç»„å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚`,
            detail: 'å¯¼å…¥åå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½é‡è¦æ•°æ®ã€‚'
          });

          if (confirmResult.confirmed) {
            history = importData.history;
            if (importData.historyTags) {
              historyTags = importData.historyTags;
            }

            (async function () {
              await saveHistory();
              await saveHistoryTags();
              renderHistory();
              showToast(`æˆåŠŸå¯¼å…¥ ${history.length} ä¸ªå¡ç»„`, 'success');
            })();
          } else {
            showToast('å¯¼å…¥å·²å–æ¶ˆ', 'info');
          }
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('å¯¼å…¥å¤±è´¥:', error);
        showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    // æ•°æ®ç®¡ç†äº‹ä»¶ç»‘å®š
    console.log('=== ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ ===');
    const exportBtn = document.getElementById('exportDataBtn');
    const importBtn = document.getElementById('importDataBtn');

    console.log('exportBtn:', exportBtn);
    console.log('importBtn:', importBtn);

    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        console.log('å¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»');
        exportAllData();
      });
      console.log('âœ… å¯¼å‡ºæŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
    } else {
      console.log('âŒ å¯¼å‡ºæŒ‰é’®æœªæ‰¾åˆ°');
    }

    if (importBtn) {
      importBtn.addEventListener('click', () => {
        console.log('å¯¼å…¥æŒ‰é’®è¢«ç‚¹å‡»');
        importData();
      });
      console.log('âœ… å¯¼å…¥æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
    } else {
      console.log('âŒ å¯¼å…¥æŒ‰é’®æœªæ‰¾åˆ°');
    }

    // é‡ç½®è¡¨å•
    function resetForm() {
      clearAllInputs();

      // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®
      document.querySelector(".remove-group").onclick = function () {
        this.parentElement.remove();
      };

      // é‡ç½®ç”ŸæˆæŒ‰é’®
      const generateBtn = document.getElementById("generate");
      generateBtn.textContent = "ç”Ÿæˆé…å¯¹é¢˜";
      generateBtn.onclick = function () {
        // æ¢å¤åŸæ¥çš„ç”Ÿæˆé€»è¾‘
        // éªŒè¯é¢˜ç›®åç§°
        const titleInput = document.getElementById("cardSetTitle");
        const titleTip = document.getElementById("titleRequiredTip");
        if (!titleInput.value.trim()) {
          titleTip.style.display = "inline";
          titleInput.focus();
          showToast("è¯·è¾“å…¥é¢˜ç›®åç§°", "error");
          return;
        } else {
          titleTip.style.display = "none";
        }

        // éªŒè¯åˆ†ç»„æ•°é‡
        const groupNames = document.querySelectorAll(".group-name");
        const groupItems = document.querySelectorAll(".group-items");
        const validGroups = [];

        groupNames.forEach((nameInput, index) => {
          const groupName = nameInput.value.trim();
          if (!groupName) return;

          const items = groupItems[index].value
            .split(/[\n,]+/)
            .map((s) => s.trim())
            .filter((s) => s);

          if (items.length === 0) {
            showToast(`åˆ†ç»„"${groupName}"è‡³å°‘éœ€è¦1ä¸ªæ¡ç›®`, "error");
            groupItems[index].focus();
            return;
          }

          validGroups.push({ name: groupName, items: items });
        });

        if (validGroups.length < 2) {
          showToast("è‡³å°‘éœ€è¦2ä¸ªåˆ†ç»„", "error");
          return;
        }

        if (validGroups.length > 6) {
          showToast("æœ€å¤šæ”¯æŒ6ä¸ªåˆ†ç»„ï¼Œå½“å‰æœ‰" + validGroups.length + "ä¸ªåˆ†ç»„", "error");
          return;
        }

        // æ£€æŸ¥æ‰€æœ‰åˆ†ç»„å†…çš„é¡¹ç›®åç§°æ˜¯å¦æœ‰é‡å¤
        const allItems = [];
        const duplicateItems = [];

        validGroups.forEach((group) => {
          group.items.forEach((item) => {
            if (allItems.includes(item)) {
              duplicateItems.push(item);
            } else {
              allItems.push(item);
            }
          });
        });

        if (duplicateItems.length > 0) {
          const uniqueDuplicates = [...new Set(duplicateItems)];
          showToast(`æ·»åŠ å¤±è´¥ï¼šé¡¹ç›®åç§°"${uniqueDuplicates.join('ã€')}"é‡å¤ï¼Œè¯·é‡æ–°ç¼–è¾‘`, "error");
          return;
        }

        allFactors = [];
        correctAnswers = {};

        validGroups.forEach((group) => {
          group.items.forEach((item) => {
            allFactors.push({ text: item, group: group.name, correct: false });
          });
          correctAnswers[group.name] = group.items;
        });

        const cardSetTitle = titleInput.value.trim() || `å¡ç»„${history.length + 1}`;

        // æ£€æŸ¥å¡ç»„åç§°æ˜¯å¦é‡å¤
        const existingCard = history.find(card => card.title === cardSetTitle);
        if (existingCard) {
          showToast(`å¡ç»„åç§°"${cardSetTitle}"å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`, "error");
          titleInput.focus();
          return;
        }

        history.push({
          title: cardSetTitle,
          tags: [...currentTags],
          factors: JSON.parse(JSON.stringify(allFactors)),
          correctAnswers: JSON.parse(JSON.stringify(correctAnswers)),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        (async function () {
          await saveHistory();
          renderHistory();
        })();
        renderMatchingArea(allFactors, correctAnswers);
      };
    }

    // æˆæƒéªŒè¯äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('authSubmitBtn').addEventListener('click', async function () {
      const authCode = document.getElementById('authCodeInput').value.trim();
      if (!authCode) {
        showToast('è¯·è¾“å…¥æˆæƒç ', 'error');
        return;
      }

      try {
        const success = await validateAuthCode(authCode);
        if (success) {
          document.getElementById('authCodeInput').value = '';
        } else {
          showToast('æˆæƒç éªŒè¯å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æˆæƒéªŒè¯å¤±è´¥:', error);
        showToast('æˆæƒéªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    });

    // æˆæƒç è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    document.getElementById('authCodeInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        document.getElementById('authSubmitBtn').click();
      }
    });

    // é€€å‡ºç™»å½•æŒ‰é’®äº‹ä»¶
    document.getElementById('logoutBtn').addEventListener('click', logout);



    // è°ƒè¯•ï¼šæ£€æŸ¥Electron APIæ˜¯å¦å¯ç”¨
    console.log('=== Electron API æ£€æŸ¥ ===');
    console.log('window.electronAPI:', typeof window.electronAPI !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
    if (typeof window.electronAPI !== 'undefined') {
      console.log('electronAPIæ–¹æ³•:', Object.keys(window.electronAPI));
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿è°ƒè¯•
    window.testExport = exportAllData;
    window.testImport = importData;
    console.log('âœ… æµ‹è¯•å‡½æ•°å·²æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ');
    console.log('å¯ä»¥åœ¨æ§åˆ¶å°è¿è¡Œ: testExport() æˆ– testImport() æ¥æµ‹è¯•');

    // æ·»åŠ é”™è¯¯å¤„ç†
    window.addEventListener('error', function (e) {
      console.error('JavaScripté”™è¯¯:', e.error);
      console.error('é”™è¯¯æ–‡ä»¶:', e.filename);
      console.error('é”™è¯¯è¡Œå·:', e.lineno);
      console.error('é”™è¯¯åˆ—å·:', e.colno);
    });

    // æ£€æŸ¥å‡½æ•°æ˜¯å¦æ­£ç¡®å®šä¹‰
    console.log('=== å‡½æ•°å®šä¹‰æ£€æŸ¥ ===');
    console.log('exportAllData:', typeof exportAllData);
    console.log('importData:', typeof importData);
    console.log('showToast:', typeof showToast);

    // æˆæƒç ç®¡ç†æŒ‰é’®äº‹ä»¶ï¼ˆä»…å¼€å‘è€…æ¨¡å¼ï¼‰
    // document.getElementById('licenseBtn').addEventListener('click', function () {
    //   // æ‰“å¼€æˆæƒç ç®¡ç†é¡µé¢
    //   window.open('src/pages/license-manager.html', '_blank');
    // });

    // å¸®åŠ©æŒ‰é’®å’Œtooltipé€»è¾‘
    document.addEventListener('DOMContentLoaded', function () {
      const helpBtn = document.getElementById('helpBtn');
      const helpTooltip = document.getElementById('helpTooltip');
      const closeHelpTooltip = document.getElementById('closeHelpTooltip');
      if (helpBtn && helpTooltip && closeHelpTooltip) {
        helpBtn.addEventListener('click', function (e) {
          helpTooltip.style.display = 'block';
        });
        closeHelpTooltip.addEventListener('click', function () {
          helpTooltip.style.display = 'none';
        });
        // ç‚¹å‡»tooltipå¤–éƒ¨å…³é—­
        document.addEventListener('mousedown', function (event) {
          if (helpTooltip.style.display === 'block' && !helpTooltip.contains(event.target) && event.target !== helpBtn) {
            helpTooltip.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>

</html>